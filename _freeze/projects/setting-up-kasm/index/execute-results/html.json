{
  "hash": "beffdf6dbed9d3dc2786a04a67ee5843",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Kasmweb setup\"\ndate: \"2023-1-26\"\ncategories: [projects]\nexecute:\n  freeze: auto\n---\n\n\n\n\n\nSchool chromebooks cannot be used for computer science. Due to a content blocking setup that is more restrictive than the Great Firewall of China, school chromebooks cannot install the necessary digital tools for software development. \n\nCurrently, you **must** have your own device to be able to participate in computer science classes. Students who are unable to obtain their own device for whatever reason are denied participation. \n\nAlthough getting the chromebooks unlocked to be able to install software is a complex, potentially legal problem, there are alternatives. \n\nKasm is a remote desktop software. It runs a computer on a remote server, that can be accessed through a browser, or a chromebook. Because there are no restrictions on what can be installed when using Kasm, it makes it possible to use development tools on a chromebook. This blog post is me optimizing kasm so that it is more resource efficient, and also enabling software development tools to be easily installed on it.\n\nRoadblocks/steps: \n\n* Install Kasm on Ubuntu\n* Ensure remote server can be accessed\n* Get persistent user profiles for remote server \n* Allow user to use nix to install software\n    * Create a shared nix cache for users\n* Create a custom dockerfile with: \n    * Nix preinstalled\n    * Perhaps a different desktop type\n* Optimize memory usage\n    * Use kernel same page merging (ksm) to deduplicate ram\n    * Use zram to optimize create  compressed swap device in ram, and use that instead of zswap, because it does not touch the disk at all, enabling a performance boost\n    * Use VM overcommit or something else to make kasm launch when it currently thinks it doesn't have enough ram. \n    * Set sysctl parameters for the features I want on boot\n\n\n# Step 1: Install and run kasm:\n\nstatus: complete\n\nTested on Ubuntu 22. Working.\n\nFrom [the kasm documenation](https://www.kasmweb.com/docs/latest/install/single_server_install.html)\n\nIgnore the system requirements step. We are going to be sidestepping that with optimization.\n\nDefault passwords are randomly generated, and output exactly once when your run the installation script. Save them to a text file or something, just don't lose them. \n\n# Using memory deduplication with docker\nstatus: implemented on other systems, but without docker yet\n\n## Turns out, memory deduplication is on by default for docker containers\n\n[Github issue where someone asked about this](https://github.com/moby/moby/issues/7950#issuecomment-179131803). The documents linked were very unclear, so I'll break it down.\n\nIf you are using overlayfs or aufs, you have memory deduplication. If you are using other storage drivers, you sacrifice memory for more i/o (write/read) performance.\n\nFrom [here](https://docs.docker.com/storage/storagedriver/select-storage-driver/):\n\n![](currentstoragedriver.png)\n\nOn my ubuntu virtual machine, and the AWS ubuntu machine we are working on, Overlay2 is the storage driver:\n\n![](ubuntustoragedriver.png)\n\n## Kernel Same page merging\n\nPreviously, I tried instructions from here: https://wiki.openvz.org/KSM_(kernel_same-page_merging). However, I noticed only a minimal space saved using the LD_PRELOAD steps. Not useful. \n\nI then tried cachyos fork of uksmd: https://github.com/CachyOS/uksmd, a daemon to go through userspace tasks and dedupe them.\n\nOnly works with a kernel that has the pmadv_ksm() syscall. Exists in most kernels optimized for desktop usage, like linux-zen, linux-liqourix, or pf-kernel (the original creators of uksmd)\n\nTo check if your currently running kernel has the feature:\n\n* on Archlinux, check if the files `sys_enter_pmadv_ksm` and `sys_exit_pmadv_ksm` exist in `/sys/kernel/debug/tracing/events/syscalls` (default does not have this feature, but linux-zen does)\n* on Ubuntu check if lines containing pmadv exist in the file `/proc/kallsyms` \n\n\n![uksmstats](uksmdstatsdesktop.png)\n\nHalf a gig of ram saved on a normal desktop. Expect to see much more when multiple almost identical docker containers are launched. Very useful. It saves a lot of ram. However, there might be a better way for docker, without jumping through hoops. \n\nDoes cost a miniscule amount of cpu power, but we have more cpu power and less ram on our servers. \n\nTo install uksmd on ubuntu, you need to switch kernels. \n\n### Compiling UKSMD\n\nSteps to do so on Ubuntu 22 (you must have switched kernels):\n\n`sudo apt-get install debhelper build-essential dh-make meson pkg-config libprocps-dev libcap-ng-dev` # I think it can either be pkg-conf or pkg-config\n\n`git clone https://github.com/insilications/uksmd-clr`\n\nRename the directory to be something compatible with below steps, like uksmd-1 before you cd into it. \n\nFollow steps from [here](https://blog.devgenius.io/how-to-build-debian-packages-from-meson-ninja-d1c28b60e709)\n\n\n\n`dh_make --createorig`\n\n`dh_auto_configure --buildsystem=meson`\n\n`dpkg-buildpackage -rfakeroot -us -uc -b`\n\nThe debian package will be build in the directory above the source directory.\n\nInstall your debian package!\n\nIf you want the `uksmdstats` command for monitoring purposes, you can only get it from the cachyos github (or make your own, it's just a shell script).\n\n`sudo curl https://raw.githubusercontent.com/CachyOS/uksmd/master/uksmdstats -o /usr/bin/uksmdstats`\n\n### Switching Kernels\n\nstatus: complete\n\n`curl 'https://liquorix.net/install-liquorix.sh' | sudo bash` from the [liqourix kernel website](https://liquorix.net/)\n\nI checked if liqourix has the necessary features, and yes it does. \n\n##### Setting the Default Kernel\n\nstatus: researching\n\n[Reddit post where I ask how to set default kernel in grub](https://www.reddit.com/r/linuxquestions/comments/110a2xh/how_can_i_set_the_default_kernel_for_grub_in_a/)\n\nOn that reddit post, I talk about some flawed solutions I have found. Mainly they don't seem to be truly persistent, not surviving kernel updates, updates of grub, or installation of new kernels. This endeavor is pretty risky, because a broken grub means we will have no choice but to delete our aws and start over. I need a 100% solution.\n\nAfter grilling chatgpt through 3 wrong answers, which chatgpt presented with the absolute confidence that an AI has, it finally presented me a solution that seems like it doesn't have a risk of breaking the AWS system we are working on. \n\n![](defaultgrub.png)\n\nI need to make some adjustments, but I should be able to select for the term \"liqourix\" while removing the term \"recovery\" to select the correct kernel (but not the recovery kernel) with complete consistency even through kernel updates, grub updates, or installation of new kernels.\n\nI searched around for how to do this, but I eventually gave up and asked chatgpt again, getting this:\n\n![](chatgptgrubhelp2.png)\n\nMy 20_linux_xen is not the same as what chatgpt wants, so I asked again, and it gave me this code to put in /etc/default/grub:\n\n```\n# Set the default menu entry based on the title of the menu entry\n# that contains the word \"liqourix\" while ignoring the term \"recovery\"\nGRUB_DEFAULT=\"$(grep -E -o '^menuentry.*liqourix.*' /boot/grub/grub.cfg | grep -v 'recovery' | head -1 | awk -F\\' '{print $2}')\"\n```\n\n`grep -E -o '^menuentry.*liqourix.*' /boot/grub/grub.cfg | grep -v 'recovery' | head -1 | awk -F\\' '{print $2}'`\n\nI will test this in a virtual machine.\n\n### Weaker alternative: ksm_preload\n\nstatus: won't be used\n\n`git clone https://github.com/binfess/ksm_preload`\n\n`cmake .`\n\n`make`\n\n`sudo make install`\n\nI added `LD_PRELOAD=/usr/local/share/ksm_preload/libksm_preload.so` to the file `/etc/environment`\n\nI haven't tested the above, but I saw very minimal space saved, only about 0.11 **megabytes* saved, on my desktop. Tests on my sample server are similarly discouraging:\n\n![](ksmpreloadubuntu.png)\n\nThe above was with 2 kasm sessions open. Nearly useless. In addition to that, uksmd seems to make this completely obsolete.\n\n# Memory Overcommital\nstatus: complete\n\nAnswers were received when I [asked](https://www.reddit.com/r/kasmweb/comments/10l90wn/ram_deduplication_and_zramzswap_with_kasm/) on reddit.\n\n[The kernel has options to allow allocation of more memory than the system can give](https://www.kernel.org/doc/Documentation/vm/overcommit-accounting)\n\nDefault vm overcommit on containers is set to 0, no overcommit:\n\n![](defaultvmovercommit.png)\n\nFrom my ubuntu 22 virtual machine. I changed this setting to 1, enabling overcommit.\n\nHowever, it still did not work. In addition to that, you have to edit the kasm agent settings. In the kasm admin panel, you have to go to compute > docker agents > scroll to the right and edit the single agent. Then, change the memory override to however many gigabytes you want in **bytes**. \n\n![](agentsettings.png)\n\n# Other memory optimizations, zram and zswap\n\nPick one, using both is detrimental to performance.\n\nI don't know if zswap's deduplication feature integrates with ksm, simply compressing already deduped pages, or it dedupes them, recomputes hashes, and then does deduping seperately, like swap-on-zram would do. If zswap has integration with ksm, then it is better, but if it doesn't then zram is probably better because swap-on-zram minimizes swapping to disk, usually granting greater speeds. \n\nI've [asked on reddit](https://www.reddit.com/r/linuxquestions/comments/10sqvuj/zram_or_zswap_for_use_with_ksm/) for help with this, and apparently, zswap does not have true deduplication. The same pages filled feature simply collapses pages that are filled entirely with 0's or entirely with one's. With this tidbit of knowledge, I can decisively choose zram, as it is capable of deduplicating pages with the compression process. \n\n## zram\n\nstatus: immplemented on my personal systems, but not on the ubuntu vm yet.\n\n\nTo install zram, `sudo apt install systemd-zram-generator`\n\nThen, you can configure zram by editing /etc/systemd/zram-generator.conf\n\nThis works, but apparently, things in a swap file aren't deduplicated by uksmd. Rather, zram handles it's own deduplication, with the compression algorithms. Becuase it must hash pages, this can potentially lead to more cpu usage. \n\nBecause I don't know about this, I made yet another [reddit post](https://www.reddit.com/r/linuxquestions/comments/10sqvuj/zram_or_zswap_for_use_with_ksm/) asking about this topic.\n\n## zswap\nStatus: Partially done, but dropped in favor of zswap\n\n![](zswap.png)\n\nzswap is disabled by default on my ubuntu virtual machine. Odd that both are disabled by default.\n\nParameters for zswap can be found in `/sys/module/zswap/parameters/`\n\nTo set parameters at boot, use kernel boot paremeters, like `zswap.enabled=1 zswap.compressor=lz4 zswap.max_pool_percent=20 zswap.zpool=z3fold` \n\nI will need to tinker to see what is the most optimized zswap setup\n\n~~zswap has it's own memory deduplication feature, which is enabled by default on both my ubuntu vm and the aws ubuntu server:~~\n\nSee above, my comments about zswap's memory deduplication feature.\n\n![](zswapmemdedupe.png)\n\n# Setting Kernel/Sysctl Parameters on boot\nStatus: researching\n\n[Archwiki article](https://wiki.archlinux.org/title/Sysctl#Configuration)\n\n\n# Customized kasm images\nstatus: Complete\n\n[Building](https://www.kasmweb.com/docs/latest/how_to/building_images.html) and [maintaining](https://www.kasmweb.com/docs/latest/how_to/building_images.html) custom docker images\n\nI have forked the Dockerfile github repos that kasm uses to build their images.\n\n\n[https://github.com/moonpiedumplings/nighthawk-workspaces-core-images](https://github.com/moonpiedumplings/nighthawk-workspaces-core-images)\n\n\n[https://github.com/moonpiedumplings/nighthawk-workspaces](https://github.com/moonpiedumplings/nighthawk-workspaces)\n\n\nClone that, cd into it, and then run:\n\n`docker build . -f [The dockerfile you want]` which should build an image.  \n\nThe current image I am experimenting with is in with both repos are the images with nighthawkcoders in the name.\n\nWhat worked was:\n\n`RUN apt update && apt install nix-bin`\n\nYou can add that to any of the ubuntu images, but the image I am using is in my nighthawk-workspaces repo, called dockerfile-kasm-ubuntu-jammy-nighthawkcoders.\n\nI pushed it to the docker hub, and it can be found on docker at moonpiedumplings/kasm-ubuntu-jammy-nighthawkcoders:0.5. To use this, I recommend just cloning the existing ubuntu jammy image, and replacing the docker image with our nighthawkcoders one. \n\n![](dockerimage.png)\n\nThen, you have to adjust the kasm workspaces settings, as described below, to get nix working properly, like mounting the nix store. The command listed does not create the nix store.\n\n\n# Nix remote store\n\nStatus: complete, all the way\n\nI've created a [reddit post](https://www.reddit.com/r/NixOS/comments/10q9db1/shared_nix_store_between_docker_containers/) relating to this topic. I've received several replies, but I still struggled, so I ended up asking on discord (ugh) for help, where I instantly received the answer to my problem. I've updated my reddit post, editing it with the solution.\n\nTo get this working, install nix using a multi user installation on the host:\n\n`sh <(curl -L https://nixos.org/nix/install) --daemon`\n\nThen stop the container, and restart it with a correctly mounted nix store:\n\n`/nix:/nix:ro` as a docker bind mount.\n\nTo use this docker mount with kasm, you need to use volume mapping workspace setting:\n\n\n\n\n\n```{json}\n{\n  \"/nix\": {\n    \"bind\": \"/nix\",\n    \"mode\": \"ro\",\n    \"uid\": 1000,\n    \"gid\": 1000,\n    \"required\": true,\n    \"skip_check\": false\n  }\n}\n```\n\n\n\n\n\n![](volumemappings.png)\n\nAnd finally, you need to ensure the nix in docker is always using the daemon.\n\nThe environment variable`NIX_REMOTE=daemon` needs to be set inside the container.\n\nIn addition to this, two other environment variables must be set, LD_LIBRARY_PATH (default breaks nix), and LC_ALL must be unset to suppress a warning that doesn't interfere with the usage of nix but is really annoying.\n\nYou can set the necessary environment variables using kasm docker run config override workspace setting:\n\n\n\n\n\n```{json}\n{\n  \"environment\": {\n    \"NIX_REMOTE\": \"daemon\",\n    \"LD_LIBRARY_PATH\": \"/opt/libjpeg-turbo:usr/local/nvidia/lib:usr/local/nvidia/lib64\",\n    \"LC_ALL\": \"\"\n  }\n}\n```\n\n\n\n\n\n![](envvars.png)\n\n\n# Persistent profiles: \n\nStatus: complete\n\nGuides on Kasm docs:\n\n[In depth guide + youtube video](https://www.kasmweb.com/docs/latest/guide/persistent_data/persistent_profiles.html)\n\n[Shorter quick how-to](https://www.kasmweb.com/docs/latest/how_to/persistent_profiles.html)\n\nIn the  workspace configuration, set persistent profile path to `/mnt/kasm/nighthawkcoders/{username}`\n\n![](persistentprofile.png)\n\n",
    "supporting": [
      "index_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}