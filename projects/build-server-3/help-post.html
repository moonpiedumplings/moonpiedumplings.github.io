<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Jeffrey Fonseca – help-post</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jeffrey Fonseca</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../projects/index.html" rel="" target="">
 <span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/index.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../playground/index.html" rel="" target="">
 <span class="menu-text">Playground</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../guides/index.html" rel="" target="">
 <span class="menu-text">Guides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talks/index.html" rel="" target="">
 <span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../writeups/index.html" rel="" target="">
 <span class="menu-text">Writeups</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/moonpiedumplings" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#caddy-acme-challenge-is-on-80-despite-me-having-http_port-set-to-8080" id="toc-caddy-acme-challenge-is-on-80-despite-me-having-http_port-set-to-8080" class="nav-link active" data-scroll-target="#caddy-acme-challenge-is-on-80-despite-me-having-http_port-set-to-8080">Caddy acme challenge is on :80 despite me having http_port set to 8080</a>
  <ul class="collapse">
  <li><a href="#the-problem-im-having" id="toc-the-problem-im-having" class="nav-link" data-scroll-target="#the-problem-im-having">1. The problem I’m having:</a></li>
  <li><a href="#error-messages-andor-full-log-output" id="toc-error-messages-andor-full-log-output" class="nav-link" data-scroll-target="#error-messages-andor-full-log-output">2. Error messages and/or full log output:</a></li>
  <li><a href="#caddy-version" id="toc-caddy-version" class="nav-link" data-scroll-target="#caddy-version">3. Caddy version</a>
  <ul class="collapse">
  <li><a href="#how-i-ran-caddy" id="toc-how-i-ran-caddy" class="nav-link" data-scroll-target="#how-i-ran-caddy">How I ran caddy</a></li>
  <li><a href="#a.-system-environment" id="toc-a.-system-environment" class="nav-link" data-scroll-target="#a.-system-environment">a. System environment:</a></li>
  <li><a href="#b.-command" id="toc-b.-command" class="nav-link" data-scroll-target="#b.-command">b. Command:</a></li>
  <li><a href="#c.-serviceunitcompose-file" id="toc-c.-serviceunitcompose-file" class="nav-link" data-scroll-target="#c.-serviceunitcompose-file">c.&nbsp;Service/unit/compose file:</a></li>
  <li><a href="#d.-my-complete-caddy-config" id="toc-d.-my-complete-caddy-config" class="nav-link" data-scroll-target="#d.-my-complete-caddy-config">d.&nbsp;My complete Caddy config:</a></li>
  <li><a href="#links-to-relevant-resources" id="toc-links-to-relevant-resources" class="nav-link" data-scroll-target="#links-to-relevant-resources">5. Links to relevant resources:</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<!--
Hi. Welcome! :)

- YOU MUST USE THIS TEMPLATE TO GET HELP. DO NOT DELETE IT.
- Please use code blocks: https://superuser.com/editing-help
- We want to help you, but if you ignore or skip questions in this template, we will just ask you to fill it out anyway.
- If your post is hard to read, people will not want to help.

Thanks!
-->
<section id="caddy-acme-challenge-is-on-80-despite-me-having-http_port-set-to-8080" class="level1">
<h1>Caddy acme challenge is on :80 despite me having http_port set to 8080</h1>
<section id="the-problem-im-having" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-im-having">1. The problem I’m having:</h2>
<!-- What are you trying to do? What isn't working? Please describe the issue thoroughly enough so that anyone can reproduce the exact behavior you're seeing. Be as specific as possible. Use `curl -vL` to show example requests. DO NOT USE WEB BROWSERS HERE. Browsers have subtle caching behaviours which can make testing difficult. -->
<p>My goal is to have my entire server configured by ansible: https://github.com/moonpiedumplings/server-configs</p>
<p>The short version is: I’m using a tunneling software called rathole to forwad 80 and 443 from my public server to 8080. I’m currently having trouble starting and configuring the caddy container.</p>
</section>
<section id="error-messages-andor-full-log-output" class="level2">
<h2 class="anchored" data-anchor-id="error-messages-andor-full-log-output">2. Error messages and/or full log output:</h2>
<!--
Please DO NOT REDACT any information except credentials. Leave domain names intact!
Please DO NOT POST TRUNCATED LOG LINES as systemd is notorious for this.
Please USE THIS COMMAND TO VIEW LOGS with systemd:
    $ journalctl -u caddy --no-pager | less +G`
Please DO NOT USE WEB BROWSERS. Use `curl -vL` instead.
Please ENABLE DEBUG MODE FIRST by adding "debug" to the global options of your Caddyfile. See https://caddyserver.com/docs/caddyfile/options#debug for an example.
-->
<pre><code>podmaner@thoth:~$ podman logs caddy
{"level":"info","ts":1709764202.680097,"msg":"using provided configuration","config_file":"/etc/caddy/Caddyfile","config_adapter":"caddyfile"}
{"level":"warn","ts":1709764202.6819184,"msg":"Caddyfile input is not formatted; run 'caddy fmt --overwrite' to fix inconsistencies","adapter":"caddyfile","f
{"level":"info","ts":1709764202.6830893,"logger":"admin","msg":"admin endpoint started","address":"localhost:2019","enforce_origin":false,"origins":["//local
{"level":"info","ts":1709764202.683326,"logger":"http.auto_https","msg":"server is listening only on the HTTPS port but has no TLS connection policies; addin
{"level":"warn","ts":1709764202.6833456,"logger":"http.auto_https","msg":"automatic HTTP-&gt;HTTPS redirects are disabled","server_name":"srv0"}
{"level":"info","ts":1709764202.6833808,"logger":"tls.cache.maintenance","msg":"started background certificate maintenance","cache":"0xc00059b200"}
{"level":"warn","ts":1709764202.6837733,"logger":"tls","msg":"unable to get instance ID; storage clean stamps will be incomplete","error":"open /data/caddy/i
{"level":"info","ts":1709764202.6837904,"logger":"http","msg":"enabling HTTP/3 listener","addr":":8443"}
{"level":"info","ts":1709764202.6839085,"msg":"failed to sufficiently increase receive buffer size (was: 208 kiB, wanted: 2048 kiB, got: 416 kiB). See https:
{"level":"info","ts":1709764202.684088,"logger":"http.log","msg":"server running","name":"srv0","protocols":["h1","h2","h3"]}
{"level":"info","ts":1709764202.6840968,"logger":"http","msg":"enabling automatic TLS certificate management","domains":["sso.moonpiedumpl.ing","hello.moonpi
{"level":"info","ts":1709764202.6854613,"msg":"autosaved config (load with --resume flag)","file":"/config/caddy/autosave.json"}
{"level":"info","ts":1709764202.6859457,"msg":"serving initial configuration"}
{"level":"info","ts":1709764202.688153,"logger":"tls.obtain","msg":"acquiring lock","identifier":"sso.moonpiedumpl.ing"}
{"level":"info","ts":1709764202.6883264,"logger":"tls.obtain","msg":"acquiring lock","identifier":"hello.moonpiedumpl.ing"}
{"level":"info","ts":1709764202.6884,"logger":"tls.obtain","msg":"acquiring lock","identifier":"test.moonpiedumpl.ing"}
{"level":"info","ts":1709764202.6925972,"logger":"tls","msg":"cleaning storage unit","storage":"FileStorage:/data/caddy"}
{"level":"info","ts":1709764202.6940203,"logger":"tls","msg":"finished cleaning storage units"}
{"level":"info","ts":1709764202.6955667,"logger":"tls.obtain","msg":"lock acquired","identifier":"sso.moonpiedumpl.ing"}
{"level":"info","ts":1709764202.6955748,"logger":"tls.obtain","msg":"lock acquired","identifier":"test.moonpiedumpl.ing"}
{"level":"info","ts":1709764202.6955786,"logger":"tls.obtain","msg":"lock acquired","identifier":"hello.moonpiedumpl.ing"}
{"level":"info","ts":1709764202.6957052,"logger":"tls.obtain","msg":"obtaining certificate","identifier":"sso.moonpiedumpl.ing"}
{"level":"info","ts":1709764202.6957242,"logger":"tls.obtain","msg":"obtaining certificate","identifier":"test.moonpiedumpl.ing"}
{"level":"info","ts":1709764202.6957483,"logger":"tls.obtain","msg":"obtaining certificate","identifier":"hello.moonpiedumpl.ing"}
{"level":"info","ts":1709764202.9553177,"logger":"tls.issuance.acme","msg":"waiting on internal rate limiter","identifiers":["hello.moonpiedumpl.ing"],"ca":"https://acme-v02.api.letsencrypt.org/directory","account":"moonpiedumplings2@gmail.com"}
{"level":"info","ts":1709764202.955384,"logger":"tls.issuance.acme","msg":"done waiting on internal rate limiter","identifiers":["hello.moonpiedumpl.ing"],"ca":"https://acme-v02.api.letsencrypt.org/directory","account":"moonpiedumplings2@gmail.com"}
{"level":"info","ts":1709764202.9641545,"logger":"tls.issuance.acme","msg":"waiting on internal rate limiter","identifiers":["test.moonpiedumpl.ing"],"ca":"https://acme-v02.api.letsencrypt.org/directory","account":"moonpiedumplings2@gmail.com"}
{"level":"info","ts":1709764202.964186,"logger":"tls.issuance.acme","msg":"done waiting on internal rate limiter","identifiers":["test.moonpiedumpl.ing"],"ca":"https://acme-v02.api.letsencrypt.org/directory","account":"moonpiedumplings2@gmail.com"}
{"level":"info","ts":1709764203.0985403,"logger":"tls.issuance.acme","msg":"waiting on internal rate limiter","identifiers":["sso.moonpiedumpl.ing"],"ca":"https://acme-v02.api.letsencrypt.org/directory","account":"moonpiedumplings2@gmail.com"}
{"level":"info","ts":1709764203.0985787,"logger":"tls.issuance.acme","msg":"done waiting on internal rate limiter","identifiers":["sso.moonpiedumpl.ing"],"ca":"https://acme-v02.api.letsencrypt.org/directory","account":"moonpiedumplings2@gmail.com"}
{"level":"info","ts":1709764203.2928238,"logger":"tls.issuance.acme.acme_client","msg":"trying to solve challenge","identifier":"test.moonpiedumpl.ing","challenge_type":"tls-alpn-01","ca":"https://acme-v02.api.letsencrypt.org/directory"}
{"level":"info","ts":1709764203.434616,"logger":"tls.issuance.acme.acme_client","msg":"trying to solve challenge","identifier":"sso.moonpiedumpl.ing","challenge_type":"tls-alpn-01","ca":"https://acme-v02.api.letsencrypt.org/directory"}
{"level":"error","ts":1709764203.478285,"logger":"tls.obtain","msg":"could not get certificate from issuer","identifier":"test.moonpiedumpl.ing","issuer":"acme-v02.api.letsencrypt.org-directory","error":"[test.moonpiedumpl.ing] solving challenges: presenting for challenge: presenting with embedded solver: could not start listener for challenge server at :443: listen tcp :443: bind: permission denied (order=https://acme-v02.api.letsencrypt.org/acme/order/1605766427/250173951227) (ca=https://acme-v02.api.letsencrypt.org/directory)"}</code></pre>
<p>And then more of the same, for my various domain names.</p>
</section>
<section id="caddy-version" class="level2">
<h2 class="anchored" data-anchor-id="caddy-version">3. Caddy version</h2>
<p>Caddy 2.7.6, running in podman rootless.</p>
<p>For exact details of how I ran it, you can see the <a href="https://github.com/moonpiedumplings/server-configs/blob/ba757ecb13c4dce443ef77e17cdd257b34f8695d/roles/caddy/tasks/main.yml">main task file of the relevant ansible role</a></p>
<p>I decided to use host networking, rather than port forwarding from the podman container, because from my testing, podman cannot curl localhost when the ports are forwarded and the firewall is up.</p>
<p>In the future, I want to set up something like https://www.kasmweb.com/, and having caddy be host networking buts it behind any firewalls I would be running, rather than next to it, or along side it.</p>
<section id="how-i-ran-caddy" class="level3">
<h3 class="anchored" data-anchor-id="how-i-ran-caddy">How I ran caddy</h3>
</section>
<section id="a.-system-environment" class="level3">
<h3 class="anchored" data-anchor-id="a.-system-environment">a. System environment:</h3>
<p>Debian 12</p>
</section>
<section id="b.-command" class="level3">
<h3 class="anchored" data-anchor-id="b.-command">b. Command:</h3>
<!--
Commands are what you type into a terminal, i.e. the command you use to run Caddy.
Please read https://caddyserver.com/docs/running to understand the recommended commands to run Caddy, depending on your installation method.
-->
<p>From the <code>podman inspect caddy</code></p>
<pre><code> "Cmd": [
                    "caddy",
                    "run",
                    "--config",
                    "/etc/caddy/Caddyfile",
                    "--adapter",
                    "caddyfile"
               ],</code></pre>
</section>
<section id="c.-serviceunitcompose-file" class="level3">
<h3 class="anchored" data-anchor-id="c.-serviceunitcompose-file">c.&nbsp;Service/unit/compose file:</h3>
<pre><code> - name: Run caddy container
      containers.podman.podman_container:
        name: caddy
        image: localhost/local/caddy:latest
        # image: docker.io/caddy
        state: started # or absent  
        recreate: true
        network: host
        volumes:
          - "{{ homepath.stdout }}/caddy/config/Caddyfile:/etc/caddy/Caddyfile"
          - "{{ homepath.stdout }}/caddy/data:/data"
          - "{{ homepath.stdout }}/caddy/caddy_config:/config"
        cap_add:
          - NET_ADMIN
        restart_policy: "always"
        force_restart: true</code></pre>
<p>(I tested and I get this error both on the official caddy, and when I add a module via my dockerfile. I just haven’t pushed those to github yet).</p>
</section>
<section id="d.-my-complete-caddy-config" class="level3">
<h3 class="anchored" data-anchor-id="d.-my-complete-caddy-config">d.&nbsp;My complete Caddy config:</h3>
<p>jinja2 template: https://github.com/moonpiedumplings/server-configs/blob/c46b5f88a3aae107cff44f68c62b0cd23f9e9283/roles/caddy/templates/Caddyfile.j2</p>
<p>Post deploy, on the actual server:</p>
<pre><code>{
    http_port 8080
    https_port 8443
    servers {
        trusted_proxies static 154.12.245.181
    }
    email moonpiedumplings2@gmail.com

    auto_https disable_redirects
}
test.moonpiedumpl.ing {
    reverse_proxy http://127.0.0.1:8000
}
sso.moonpiedumpl.ing {
    reverse_proxy http://127.0.0.1:9000
}


hello.moonpiedumpl.ing {
    respond "Hello World!"
}</code></pre>
</section>
<section id="links-to-relevant-resources" class="level3">
<h3 class="anchored" data-anchor-id="links-to-relevant-resources">5. Links to relevant resources:</h3>
<p>I try to document everything I do on my blog: https://moonpiedumplings.github.io/projects/build-server-3/#caddy</p>
<p>There is also my github server configs: https://github.com/moonpiedumplings/server-configs</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>