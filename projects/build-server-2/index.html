<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-08-02">

<title>Jeffrey Fonseca – Building my own Server Part 2 — Software</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jeffrey Fonseca</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../projects/index.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../playground/index.html"> 
<span class="menu-text">Playground</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../guides/index.html"> 
<span class="menu-text">Guides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talks/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../writeups/index.html"> 
<span class="menu-text">Writeups</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/moonpiedumplings"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#software" id="toc-software" class="nav-link active" data-scroll-target="#software">Software</a>
  <ul>
  <li><a href="#software-suite" id="toc-software-suite" class="nav-link" data-scroll-target="#software-suite">Software Suite</a></li>
  <li><a href="#openstack" id="toc-openstack" class="nav-link" data-scroll-target="#openstack">Openstack</a>
  <ul class="collapse">
  <li><a href="#skylinehorizon" id="toc-skylinehorizon" class="nav-link" data-scroll-target="#skylinehorizon">Skyline/Horizon</a></li>
  <li><a href="#multi-tenancy." id="toc-multi-tenancy." class="nav-link" data-scroll-target="#multi-tenancy.">Multi tenancy.</a></li>
  <li><a href="#bare-metal-nodes" id="toc-bare-metal-nodes" class="nav-link" data-scroll-target="#bare-metal-nodes">Bare metal nodes</a></li>
  <li><a href="#magnum" id="toc-magnum" class="nav-link" data-scroll-target="#magnum">Magnum</a></li>
  <li><a href="#api-and-automation" id="toc-api-and-automation" class="nav-link" data-scroll-target="#api-and-automation">Api and Automation</a></li>
  <li><a href="#zun" id="toc-zun" class="nav-link" data-scroll-target="#zun">Zun</a></li>
  </ul></li>
  <li><a href="#installing-openstack" id="toc-installing-openstack" class="nav-link" data-scroll-target="#installing-openstack">Installing Openstack</a>
  <ul class="collapse">
  <li><a href="#operating-system" id="toc-operating-system" class="nav-link" data-scroll-target="#operating-system">Operating system</a></li>
  <li><a href="#kolla-ansible" id="toc-kolla-ansible" class="nav-link" data-scroll-target="#kolla-ansible">Kolla-ansible</a></li>
  <li><a href="#router-networking" id="toc-router-networking" class="nav-link" data-scroll-target="#router-networking">Router Networking</a></li>
  <li><a href="#vps-networking" id="toc-vps-networking" class="nav-link" data-scroll-target="#vps-networking">VPS Networking</a>
  <ul class="collapse">
  <li><a href="#macvtap" id="toc-macvtap" class="nav-link" data-scroll-target="#macvtap">Macvtap</a></li>
  <li><a href="#bridge-veth" id="toc-bridge-veth" class="nav-link" data-scroll-target="#bridge-veth">Bridge + Veth</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  <li><a href="#deploying-and-using-openstack" id="toc-deploying-and-using-openstack" class="nav-link" data-scroll-target="#deploying-and-using-openstack">Deploying and Using Openstack</a>
  <ul>
  <li><a href="#monitoring" id="toc-monitoring" class="nav-link" data-scroll-target="#monitoring">Monitoring</a></li>
  <li><a href="#cinder" id="toc-cinder" class="nav-link" data-scroll-target="#cinder">Cinder</a></li>
  <li><a href="#nova" id="toc-nova" class="nav-link" data-scroll-target="#nova">Nova</a>
  <ul class="collapse">
  <li><a href="#lxc" id="toc-lxc" class="nav-link" data-scroll-target="#lxc">LXC</a></li>
  <li><a href="#gpu-passthrough" id="toc-gpu-passthrough" class="nav-link" data-scroll-target="#gpu-passthrough">GPU passthrough</a></li>
  </ul></li>
  <li><a href="#zun-1" id="toc-zun-1" class="nav-link" data-scroll-target="#zun-1">Zun</a></li>
  <li><a href="#cyborg" id="toc-cyborg" class="nav-link" data-scroll-target="#cyborg">Cyborg</a></li>
  <li><a href="#skyline" id="toc-skyline" class="nav-link" data-scroll-target="#skyline">Skyline</a></li>
  <li><a href="#magnum-1" id="toc-magnum-1" class="nav-link" data-scroll-target="#magnum-1">Magnum</a></li>
  <li><a href="#neutron" id="toc-neutron" class="nav-link" data-scroll-target="#neutron">Neutron</a>
  <ul class="collapse">
  <li><a href="#ipv6" id="toc-ipv6" class="nav-link" data-scroll-target="#ipv6">IPv6</a></li>
  </ul></li>
  <li><a href="#multi-node-install" id="toc-multi-node-install" class="nav-link" data-scroll-target="#multi-node-install">Multi Node Install</a></li>
  <li><a href="#ipv6-on-contabo" id="toc-ipv6-on-contabo" class="nav-link" data-scroll-target="#ipv6-on-contabo">Ipv6 on Contabo</a></li>
  <li><a href="#network-interfaces" id="toc-network-interfaces" class="nav-link" data-scroll-target="#network-interfaces">Network interfaces</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Building my own Server Part 2 — Software</h1>
  <div class="quarto-categories">
    <div class="quarto-category">linux</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 2, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>STATUS: see <a href="../build-server-3/">part 3</a>, where I don’t start with openstack.</p>
<p>I have other stuff to do that needs my server working, and since I already have remote libvirt setup, I will just stick to that for now.</p>
<p>But I don’t think I am giving up on openstack, since what I want seems to be possible, just very difficult.</p>
<section id="software" class="level1">
<h1>Software</h1>
<section id="software-suite" class="level2">
<h2 class="anchored" data-anchor-id="software-suite">Software Suite</h2>
<p>I want an easy install, but I also want lots of features. Here are some things I have looked at:</p>
<ul>
<li>Proxmox VE</li>
<li>Xen Orchestra</li>
<li>Openstack</li>
<li><a href="https://github.com/canonical/lxd-ui">Canonicals LXD UI</a></li>
<li>Ovirt</li>
<li>Harvester</li>
<li>OpenVZ</li>
</ul>
</section>
<section id="openstack" class="level2">
<h2 class="anchored" data-anchor-id="openstack">Openstack</h2>
<p>Currently, openstack appeals to me a lot. Although I originally wanted to do a bare metal install, I now realize that that is too time consuming and not realistic, so I am most likely going to use one of the automated methods of installation.</p>
<p><a href="https://docs.openstack.org/kolla-ansible/latest/">Kolla ansible</a></p>
<p>They have an easy <a href="https://docs.openstack.org/kolla-ansible/latest/user/quickstart.html">deployment guide</a> for an all in one node, perfect for my single server.</p>
<p>I will definitely not use every service, but I do want to use openstack because of the sheer number of services it offers. Openstack offers every single feature of other virtualization platforms, at the cost of complexity. Here are the features that made me decide I needed that complexity.</p>
<section id="skylinehorizon" class="level3">
<h3 class="anchored" data-anchor-id="skylinehorizon">Skyline/Horizon</h3>
<p>Openstack has a previous generation web ui, horizon, and a newer generation web ui, skyline. These web ui’s offer all the features of other web based virtualization platforms like proxmox, but they also let you configure the other things of openstack.</p>
<p><img src="https://external-content.duckduckgo.com/iu/?u=http%3A%2F%2Fwww.itzgeek.com%2Fwp-content%2Fuploads%2F2015%2F07%2FOpenStack-Configure-Horizon-Instance-Console.jpg&amp;f=1&amp;nofb=1&amp;ipt=c31c95fcc86ecd2a334a098fddcf51cbdad6b8c3b3d1bd1257b28dbc4b7cb17e&amp;ipo=images" class="img-fluid"></p>
<p>And they have some special features, like giving you a visual layout of network topology.</p>
<p><img src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fi.ytimg.com%2Fvi%2Fz6ftW7fUdp4%2Fmaxresdefault.jpg&amp;f=1&amp;nofb=1&amp;ipt=4e02ee4eb9751d8f6d2ae8693ca223d0626deef5779ec2fe01e614be210a4c5e&amp;ipo=images" class="img-fluid"></p>
</section>
<section id="multi-tenancy." class="level3">
<h3 class="anchored" data-anchor-id="multi-tenancy.">Multi tenancy.</h3>
<p>The most important feature of openstack, in my opinion, is it’s multi tenant architechture. Unliek proxmox, which is designed for a single organization, openstack is designed in such a way that you can create extra users, which get their own allocation of resources.</p>
<p>So when I go to college, if anyone wants a VPS to play around in, I can just allocate them a few resources, and then they get their own web ui for playing with servers and networking.</p>
<p>Many public cloud services are actually using openstack in the background for it’s public tenant architecture. Openstack’s dashboards can be rebranded to be your own company:</p>
<p><img src="https://www.scalecloud.co.uk/wp-content/uploads/2017/02/vnc-console.png" class="img-fluid"></p>
</section>
<section id="bare-metal-nodes" class="level3">
<h3 class="anchored" data-anchor-id="bare-metal-nodes">Bare metal nodes</h3>
<p>Openstack saves a lot of trouble by immensely abstracting almost all the manual work that goes into putting together a modern cloud.</p>
<p>It takes it a step further, with it’s ability to treat physical, bare metal machines, as virtual machines, even automating the provisioning the same way you can do so for a virtual machine.</p>
<p><a href="https://docs.openstack.org/newton/admin-guide/baremetal.html">The docs</a> make it sound complex, but it really isn’t all that. By leveraging the <a href="">nova</a> component of openstack, which abstracts the backend drivers of virtual machines (qemu-kvm, xen, or even <a href="https://docs.openstack.org/ocata/config-reference/compute/hypervisor-hyper-v.html">hyper-v</a>) can be used as backend drivers for nova.</p>
<p>However, when combined with <a href="https://docs.openstack.org/ironic/latest/">ironic</a> openstack’s service to configure bare metal nodes, nova can also use bare metal as a driver for compute nodes. This integrates further with services like magnum…</p>
</section>
<section id="magnum" class="level3">
<h3 class="anchored" data-anchor-id="magnum">Magnum</h3>
<p>Magnum is openstack’s kubernetes-as-as-service. It provisions nodes using nova, with kubernetes clusters.</p>
<p>Now here is where I get greedy. Do I need kubernetes? No.&nbsp;Will kubernetes even be useful on a single server setup? No.&nbsp;Do I want kubernetes? Yes.</p>
<p>Here is a video demonstration, where someone uses the web ui to create a cluster using magnum.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/QvS4nDYE2r0" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>In addition to that, because openstack magnum uses openstack heat, which provisions nodes from templates, it can be used to do things like auto install nvidia drivers and container runtime.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/P4z2Hdh0l4g?start=262" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>This video is a bit outdated, so heat and magnum are much more mature since then, and have only gained more features.</p>
</section>
<section id="api-and-automation" class="level3">
<h3 class="anchored" data-anchor-id="api-and-automation">Api and Automation</h3>
<p>Openstack is designed from the ground up to be a cloud. It has first class support for their api, and everything that can be done from the UI can also be done from either the command line, or the <a href="https://docs.openstack.org/api-quick-start/">api</a>.</p>
<p>This advanced api makes it easier for other software to interact with openstack. For example, the rancher kubernetes cluster manager supports <a href="https://rke.docs.rancher.com/config-options/cloud-providers/openstack">openstack</a> as a cloud provider. It is capable of requesting nodes, provisioning them, and then setting up a kubernetes cluster entirely from the rancher web gui.</p>
</section>
<section id="zun" class="level3">
<h3 class="anchored" data-anchor-id="zun">Zun</h3>
<p>Openstack zun is the container service for openstack. It doesn’t run them in virtual machines, but instead directly on metal. It’s likely that when I want to run containerized services for actual usage, this is what I will be using instead of kubernetes since I will be using a single server, and thus won’t be able to get the benefits of kubernetes. The benefit I see form using containers is that because I have an nvidia desktop gpu, I won’t be able to use vgpu, a feature that lets you divide the gpu between virtual machines. However, containers have no such limitation.</p>
</section>
</section>
<section id="installing-openstack" class="level2">
<h2 class="anchored" data-anchor-id="installing-openstack">Installing Openstack</h2>
<p>I’ve decided to use the kolla-ansible project to install openstack. It works by using ansible to deploy docker containers, which the openstack services run in.</p>
<p>They have a quickstart guide:</p>
<p><a href="https://docs.openstack.org/kolla-ansible/latest/user/quickstart.html" class="uri">https://docs.openstack.org/kolla-ansible/latest/user/quickstart.html</a></p>
<p>And the ansible playbook can be found here:</p>
<p><a href="https://opendev.org/openstack/kolla-ansible" class="uri">https://opendev.org/openstack/kolla-ansible</a></p>
<p>And they provide a <a href="https://opendev.org/openstack/kolla-ansible/src/branch/master/ansible/inventory/multinode">sample ansible inventory</a> for the all in one node.</p>
<p>I do not need all of those features. I pretty much just want virtualized compute, networking, containers, and kubernetes. I don’t need things like an S3 compatible block storage, a relational database, or an app store. Okay, but maybe I want them.</p>
<p>I will do more research into what I want and what I don’t want, and edit the ansible playbook accordingly.</p>
<p>However, this method of deployment seems to require two NIC’s (network interface cards). I think I have both, but just in case, I noted another method of deployment, <a href="https://docs.openstack.org/openstack-ansible/latest/">openstack ansible</a> (yeah the naming isn’t the greatest), which deploys openstack without using containers, it actaully installs and configures the services on the host operating system.</p>
<p>The openstack ansible <a href="https://docs.openstack.org/openstack-ansible/latest/user/aio/quickstart.html">All in one</a> deployment, doesn’t seem to have the same requirement of two NIC’s, which I do have.</p>
<section id="operating-system" class="level3">
<h3 class="anchored" data-anchor-id="operating-system">Operating system</h3>
<p>But first, I do need to select on an operating system. Openstack is flexible and versatile, and it can be installed on multiple operating systems.</p>
<p>I was originally going to choose a RHEL compatible distro, but then RHEL made changes put the status of those in limbo.</p>
<p>I am currently deciding between:</p>
<ul>
<li>Ubuntu</li>
<li>Debian</li>
<li>RHEL (via a developer subscription)</li>
<li>A RHEL rebuild
<ul>
<li>Rocky Linux</li>
<li>Alma Linux</li>
<li>One of the academic distros, like scientific linux</li>
</ul></li>
<li>Centos Stream</li>
</ul>
<p>The important thing is that it’s a stable release distro with automatic updates. I don’t want to have to do too much manual maintainence. Ideally, I also want this distro to have newerish packages, in case I want to do some tinkering with the underlying OS, and I also want the distro to have a stable release that goes on for longer than my college years. From what I’ve heard, upgrading from one release of an OS to another can be a frustrating process, and I don’t want to have to do this while I’m in the middle of school.</p>
<p>The RHEL rebuilds do appeal to me, but they also come with extra complications, like selinux that I don’t really want to have to deal with.</p>
<p>But after much deliberation, I’ve decided on Rocky Linux. Rocky Linux 9 is officially supported by <a href="https://docs.openstack.org/kolla-ansible/latest/user/support-matrix.html">kolla ansible</a>. In addition to that, Rock Linux 9 will be <a href="https://endoflife.date/rocky-linux">supported for a good deal of time</a>, with the release being officially supported for 3 years and a bit, and that release will continue to receive security updates for 5 more years after that. More than enough to last me through college.</p>
<p>The install was very simple. I thought I would experience issues because of the Nvidia GPU, as I had been having issues with graphical monitor output with other distros, but I didn’t. A GUI appeared for me, and the install process was exceedingly simple, even simpler than debian or other distros I’ve tried. Of course, the disadvantage was that I couldn’t configure everything, like there was no option to set up users other than root, but it was very quick.</p>
<p>Now, I have RHEL installed.</p>
<p>To make management easier, I will install my favorite web administration system, <a href="../../guides/cockpit-setup/">cockpit</a>. This will also enable me to do remote management operations with a gui, things like partitioning the disks.</p>
<p>Now that I have rocky linux installed, I can install openstack using kolla-ansible.</p>
</section>
<section id="kolla-ansible" class="level3">
<h3 class="anchored" data-anchor-id="kolla-ansible">Kolla-ansible</h3>
<p>I will be following the <a href="https://docs.openstack.org/kolla-ansible/latest/user/quickstart.html">quick start guide</a></p>
<p>I will briefly go over what I am doing here, edited for my usecase. The first few steps are copy and pasted from the guide linked above.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>sudo dnf install git python3-devel libffi-devel gcc openssl-devel python3-libselinux</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>pip install 'ansible&gt;=6,&lt;8'</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pip install git+https://opendev.org/openstack/kolla-ansible@master</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>sudo mkdir -p /etc/kolla</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>sudo chown $USER:$USER /etc/kolla</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>cp -r /home/moonpie/.local/share/kolla-ansible/etc_examples/kolla/* /etc/kolla</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cp /home/moonpie/.local/share/kolla-ansible/ansible/inventory/all-in-one /home/moonpie/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, this is the initial setup. I need to customize these things to my liking.</p>
<p>Usernames and passwords a are easy, but I need to make sure the networking is right, especially since my setup will be so unorthodox. Because I am setting this up on my home network, I won’t have public internet access, as my router using <a href="https://en.wikipedia.org/wiki/Network_address_translation">NAT</a></p>
</section>
<section id="router-networking" class="level3">
<h3 class="anchored" data-anchor-id="router-networking">Router Networking</h3>
<p>It requires that I set my two network interfaces to two things: default network interface for everything else, and the neutron external interface.</p>
<p>The neutron external interface can be any physical interface, but internally, it is referred to as br-ex. This interface is responsible for letting the virtual machines interact with the internet.</p>
<p>Anyway, I had a spare router lying around, and I flashed it with <a href="https://www.freshtomato.org/">freshtomato</a> for some more advanced features. I hooked it up to my existing router, so it would be behind NAT, but now I have extra ethernet ports, so I can have a private subnet with my laptop, and the openstack stuff.</p>
<p>I was curious if tomato offered an easy way to expose services to the internet, from behind NAT, something like integration with Cloudfare’s tunnels, but they didn’t.</p>
<p>However, another idea has occured upon me: Why not just host the public parts of openstack… on the public. I could rent a VPS, and host openstack neutron, and maybe the openstack dashboards on the public.</p>
<p>For example, my current vps provdider <a href="https://webdock.io/en/docs/general-information/billing-and-pricing/additional-products#additional-/-reserved-ip-addresses">webdock</a>, gives out a range (/124) of ipv6 addresses, 16 total. Based on the pricing on that page, 1.75 Euros for an additional ipv4 address, I think I can safely assume that ipv4 addresses are more expensive, out of what I am wiling to spend, because of their scarcity.</p>
<p>However, if I can install openstack neutron on a cheap vps, thenH I will be able to give public ipv6 access to the virtual machines, which sounds like a very neat setup.</p>
<p>Since my home server won’t have public internet access I am guessing I have to start by creating a virtual network that links the two machines together, that way they can see eachother and cluster.</p>
<p>Openstack has some interesting diagrams: <a href="https://docs.openstack.org/install-guide/environment-networking.html" class="uri">https://docs.openstack.org/install-guide/environment-networking.html</a>. But I can’t find anything conclusive.</p>
<p>Since I have a router running tomato, I am thinking that I can vpn the entire router into the other machine, so that the vps I am accessing can access everything in the tomato subnet, meaning I won’t have to configure the server itself. The downside is that everything will be vpn’ed, but with a 4 TB upload limit, I’m not too concerned about that right now.</p>
<p>But sadly, webdock seems to be sold out of kvm vps’s, which have better compatibility with docker, so I will probably go looking for another platform.</p>
<p>Anyway, tomato seems to have a wireguard client installed, so I will use that, since wireguard is the fastest vpn client/server available. I found a <a href="https://golb.hplar.ch/2019/01/expose-server-vpn.html">nice guide</a> on setting up pure wireguard. However, it doesn’t discuss connecting the subnet of a router to the vps. I did find another <a href="https://gist.github.com/insdavm/b1034635ab23b8839bf957aa406b5e39">guide</a> that did. Now this guide is older, and some people criticized it for various reasons. However, it does tell me the name of what I am looking for: Site to site.</p>
<p>I found a much simpler guide on <a href="https://ubuntu.com/server/docs/wireguard-vpn-site2site">ubuntu’s website</a>. Rather than A-B-C, I only need the A-B which this offers. In addition to that, there are no iptables rules on this guide.</p>
<p>The minimum specs required for openstack neutron are: ???. The docs suck.</p>
<p>VPS provider overview:</p>
<table class="table">
<thead>
<tr class="header">
<th>Name</th>
<th>CPU</th>
<th>Ram (GB)</th>
<th>Price (/month)</th>
<th>Ipv6</th>
<th>OS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Contabo</td>
<td>4</td>
<td>8</td>
<td>$10.29</td>
<td><a href="https://contabo.com/en/customer-support/faq/#how-can-i-use-ipv6-on-my-server-at-contabo">18 quintillion</a></td>
<td>Rocky</td>
</tr>
</tbody>
</table>
<p>Okay, contabo wins. I was gonna do an actual comparison between multiple vps providers, but contabo has great specs, and it is trusted by people when I have asked around.</p>
<p>I don’t want to spend money, but this is a nice deal.</p>
<p>Also, contabo offers 32 TB out, and unlimiited in. This is definitely a very good choice.</p>
<p>After visiting <a href="https://test-ipv6.com/" class="uri">https://test-ipv6.com/</a> and realizing that my home residential wifi does not have ipv6 enabled by default (although there is an option in the router settings), I realize that the college dorms may not have ipv6 support. In that case, vpning into the remote server, which does have ipv6 support, would give me ipv6 support.</p>
<p>Now that I have a vps, I am trying to get wireguard working, by testing with my laptop I started out with the guide from ubuntu, but that doesn’t work. In addition to not having access to subnets I can only access on my laptop from my server, not even the vpn is working correctly:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>moonpie@lizard:~&gt; curl --interface wgA ifconfig.me</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>curl: (7) Failed to connect to ifconfig.me port 80 after 1 ms: Couldn't connect to server</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I found another <a href="https://www.laroberto.com/remote-lan-access-with-wireguard/">guide</a> but yet again, it’s another A-B-C guide.</p>
<p>I found a promising <a href="https://unix.stackexchange.com/questions/602267/wireguard-connection-between-two-lans-with-wireguard-boxes-behind-routers">stackexchange answer</a> with an interesting commmand I have tried:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ip route add 192.168.122.0/24 via 10.10.9.0 dev wgB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Where the 192.168.122.0/24 is the subnet I am trying to expose.</p>
<p>Okay, at this piont, I understand what I want to do pretty well. I think I will use the A-B-C guides as a template, except I only need A-B, and the router needs to eb the device that is configured not to have a permanent, static ip address, like the clients are.</p>
<p>I got lucky when I was browsing lemmy, and I found <a href="https://programming.dev/comment/1943135">forum comment</a> related to my exact issue, which then links to a <a href="https://unix.stackexchange.com/questions/638889/make-local-resources-available-when-connected-to-wireguard-vpn">stackexchange question</a>, in which the top answer uses information they sourced from this <a href="https://www.procustodibus.com/blog/2020/11/wireguard-point-to-site-config/">guide</a></p>
<p>I attempted to follow the latter guide, using a simple setup. My laptop, would be my “router”, and I was attempting to expose the vlan subnet created by the libvirt virtual machine manager to my remote server, a vps hosted on contabo.</p>
<p>Ironically, I got the connection to work, but in the wrong direction. My vps could ping my remote server, but my remote server could not ping the virtual machines on my laptop. Interestingl, it could ping my laptop using the ip of the virbr0 virtual network adapter that libvirt creates for a vlan.</p>
<p>I’m guessing that this didn’t work because I’m doing this somewhat backwards, with the device that the</p>
<p>I am guessing because I am doing this somewhat backwards, where the device exposing the lan is behind nat, whereas it is the other way around in the guides that I have seen.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>root@vmi1403809 ~]# ping 192.168.122.1</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>PING 192.168.122.1 (192.168.122.1) 56(84) bytes of data.</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>64 bytes from 192.168.122.1: icmp_seq=1 ttl=64 time=46.5 ms</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>[root@vmi1403809 ~]# ping 192.168.122.201</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>PING 192.168.122.201 (192.168.122.201) 56(84) bytes of data.</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>From 10.10.9.0 icmp_seq=1 Destination Port Unreachable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The first is the ip address of my laptop, and the second is the ip address of my debian virtual machine, which is running on my laptop.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>moonpie@lizard:~/vscode/moonpiedumplings.github.io&gt; curl --insecure  http://192.168.122.201:9090</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>&lt;html&gt;&lt;head&gt;&lt;title&gt;Moved&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Please use TLS&lt;/body&gt;&lt;/html&gt;</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>moonpie@lizard:~/vscode/moonpiedumplings.github.io&gt; curl --insecure  http://192.168.122.201:9090 --interface wgA</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>curl: (7) Failed to connect to 192.168.122.201 port 9090 after 0 ms: Couldn't connect to server</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Curl has a feature to bind to a specific interface, and when I try to test a connection using the wgA interface, it can’t connect. At first, I’m annoyed, but in hindsight, this makes sense. Only through the virbr0 interface, can I access the virtual machiens. And the virtual machines, are actually behind their own NAT. They are not public, so why would I be able to ping them?</p>
<p>Libvirt offers <a href="https://jamielinux.com/docs/libvirt-networking-handbook/">several networking options</a>. Bridged is where all virtual machines get public ip addresses. Routed is similar, but they don’t get their own interface, and it works on wirelessly connected devices. And finally, NAT, what I am using does not give virtual machines publicly accessible ip addresses.</p>
<p>Instead of running it on my actual laptop, I will try to run the vpn on the debian virtual machine instead.</p>
<p>I set up wireguard again, one side on the vps I am renting:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>/etc/wireguard/wgB.conf</strong></pre>
</div>
<div class="sourceCode" id="cb11" data-filename="/etc/wireguard/wgB.conf"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Interface]</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Address </span><span class="ot">=</span><span class="st"> 10.10.9.1/31</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="dt">PostUp </span><span class="ot">=</span><span class="st"> wg set %i private-key /etc/wireguard/%i.key</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="dt">ListenPort </span><span class="ot">=</span><span class="st"> </span><span class="dv">51000</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[Peer]</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># alpha site</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="dt">PublicKey </span><span class="ot">=</span><span class="st"> e763iTZmmMcx7HufUOi5vzmQJ5ZhYBuuqnXh/2ViBjA=</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="dt">AllowedIPs </span><span class="ot">=</span><span class="st"> 10.10.10.0/24,10.10.9.0/31,192.168.122.0/24</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And another side on my virtual machine:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>/etc/wireguard/wgA.conf</strong></pre>
</div>
<div class="sourceCode" id="cb12" data-filename="/etc/wireguard/wgA.conf"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Interface]</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Address </span><span class="ot">=</span><span class="st"> 10.10.9.1/31</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="dt">PostUp </span><span class="ot">=</span><span class="st"> wg set %i private-key /etc/wireguard/%i.key</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="dt">ListenPort </span><span class="ot">=</span><span class="st"> </span><span class="dv">51000</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[Peer]</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># alpha site</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="dt">PublicKey </span><span class="ot">=</span><span class="st"> e763iTZmmMcx7HufUOi5vzmQJ5ZhYBuuqnXh/2ViBjA=</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="dt">AllowedIPs </span><span class="ot">=</span><span class="st"> 10.10.10.0/24,10.10.9.0/31,192.168.122.0/24</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the wireguard default route didn’t work, so I removed it, and then added the route manually using the ip route tool.</p>
<p>When everything was done, my VPS could ping the ip address of my virtual machine, but not my laptop.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>[root@vmi1403809 ~]# ping 192.168.122.201 # virtual machine ip</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>PING 192.168.122.201 (192.168.122.201) 56(84) bytes of data.</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>[root@vmi1403809 ~]# ping 192.168.122.1 # laptop ip</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>PING 192.168.122.1 (192.168.122.1) 56(84) bytes of data.</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a># it just sits here forever.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Well, this is better than a strange error. However, I don’t know where to go next from here.</p>
<p>Alright, I figured it out. I’ve sourced my information from two different links:</p>
<p>The instructions for wg-quick I used are in the <a href="https://wiki.archlinux.org/title/WireGuard">arch wiki’s wireguard article</a>.</p>
<p>However, I also needed to look at the arch wiki’s <a href="https://wiki.archlinux.org/title/Internet_sharing#Enable_packet_forwarding">NAT article</a>. From that article, if you have docker enabled, you must take some extra steps that make thigns more complex. So I disabled docker, followed the instructions for NAT there.</p>
<p>And on my remote server, I ran <code>ip route add xx.xx.xx.xx/yy via zz.zz.zz.zz</code> where xx is the subnet you want to access remotely, and zz is the ip address of the remote device with access to that subnet.</p>
<p>Anyway, I find this deeply ironic. I originally wanted to deploy wireguard to my router to avoid any kind of complex networking, but because I didn’t have physical access to my router, I was testing on machines with more complex networking, which caused things to not work. This affirms my decision to set up wireguard on my router, rather than on my server, especially since kolla-ansible uses docker to deploy.</p>
<p>Anyway, I will have to look into split tunneling or whatnot, because I may not want to vpn everything.</p>
<p>The <a href="https://wiki.freshtomato.org/doku.php/wireguard_on_freshtomato">freshtomato</a> wiki contains info on how to configure wireguard, including doing things like having it start on boot.</p>
<p>Sadly, the wg-quick command doesn’t seem to be available on the router, but that’s not really a big deal. I can just write a small script which sets this up, using the instructions from the arch wiki article, or even just using wg-quick, because it tells you what steps it is taking to up the wireguard interface.</p>
<p>Here is the wg-quick file on my server:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Interface]</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Address </span><span class="ot">=</span><span class="st"> 10.10.9.1/31</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="dt">PostUp </span><span class="ot">=</span><span class="st"> wg set %i private-key /etc/wireguard/%i.key</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="dt">ListenPort </span><span class="ot">=</span><span class="st"> </span><span class="dv">51000</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[Peer]</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># alpha site</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="dt">PublicKey </span><span class="ot">=</span><span class="st"> e763iTZmmMcx7HufUOi5vzmQJ5ZhYBuuqnXh/2ViBjA=</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="dt">AllowedIPs </span><span class="ot">=</span><span class="st"> 10.10.10.0/24,10.10.9.0/31,192.168.122.0/24</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Interestingly, I didn’t have to add a specific route using <code>ip</code>. Once nat is set up correctly on one device, the, it somehow knows where to go. I only need to add allowed ips.</p>
<p>Here is configuration file for my “router” (still just testing with virtual machines).</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>/etc/wireguard/wgA.conf</strong></pre>
</div>
<div class="sourceCode" id="cb15" data-filename="/etc/wireguard/wgA.conf"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Interface]</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="dt">PreUp </span><span class="ot">=</span><span class="st"> sysctl net.ipv4.ip_forward=1</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="dt">PreUp </span><span class="ot">=</span><span class="st"> iptables -t nat -A POSTROUTING -o enp1s0 -j MASQUERADE</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="dt">PreUp </span><span class="ot">=</span><span class="st"> iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="dt">PostUp </span><span class="ot">=</span><span class="st"> wg set %i private-key /etc/wireguard/%i.key</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="dt">PostUp </span><span class="ot">=</span><span class="st"> iptables -A FORWARD -i %i -o enp1s0 -j ACCEPT</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="dt">Address </span><span class="ot">=</span><span class="st"> 10.10.9.0/31</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="dt">ListenPort </span><span class="ot">=</span><span class="st"> </span><span class="dv">51000</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="kw">[Peer]</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Remote Server</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="dt">PublicKey </span><span class="ot">=</span><span class="st"> pxCx+cEs6hoI4EE+XdE4lQiLkJRbG4JGQwXz6d/hZDM=</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="dt">AllowedIPs </span><span class="ot">=</span><span class="st"> 10.10.9.0/31</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="dt">Endpoint </span><span class="ot">=</span><span class="st"> &lt;VPS IP&gt;:51000</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="dt">PersistentKeepalive </span><span class="ot">=</span><span class="st"> </span><span class="dv">25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the steps my “router” takes when I use <code>wg-quick up wgA</code></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>root@debian:/home/moonpie# wg-quick up wgA</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>[#] sysctl net.ipv4.ip_forward=1</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>net.ipv4.ip_forward = 1</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>[#] iptables -t nat -A POSTROUTING -o enp1s0 -j MASQUERADE</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>[#] iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>[#] ip link add wgA type wireguard</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>[#] wg setconf wgA /dev/fd/63</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>[#] ip -4 address add 10.10.9.0/31 dev wgA</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>[#] ip link set mtu 1420 up dev wgA</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>[#] wg set wgA private-key /etc/wireguard/wgA.key</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>[#] iptables -A FORWARD -i wgA -o enp1s0 -j ACCEPT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this case, wgA is the wireguard interface, and enp1s0 is the interface I want to configure NAT on, so that I can access the subnet behind it.</p>
<p>Actually, wg-quick appears to just be a bash script, and I might be able to transfer that over to freshtomato.</p>
<p>The best feature of this wireguard setup is that, since it doesn’t route everything through the vpn tunnel like I was initially expecting, meaning I won’t have to worry about bandwidth or speed, since I won’t be routing all traffic through my router to a remote router.</p>
<p>In addition to all this, I can use nmap to make sure that my remote server can actually see the other services, as they are behind a kind of NAT.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>root@vmi1403809 wireguard]# nmap -sV 192.168.122.1</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>Starting Nmap 7.91 ( https://nmap.org ) at 2023-08-18 11:29 PDT</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>Nmap scan report for 192.168.122.1</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>Host is up (0.068s latency).</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>Not shown: 997 closed ports</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>PORT     STATE SERVICE         VERSION</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>53/tcp   open  domain          dnsmasq 2.89</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>8000/tcp open  http            SimpleHTTPServer 0.6 (Python 3.11.4)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>9090/tcp open  ssl/zeus-admin?</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>SF-Port9090-TCP:V=7.91%T=SSL%I=7%D=8/18%Time=64DFB8E1%P=x86_64-redhat-linu</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>... For some reason nmap can't detect cockpit so it's just 20 lines of this nonsense.</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>20\x20\x20\x20\x20\x20}\n</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>SF:\x20\x20\x20\x20\x20\x20\x20\x20p\x20");</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>Nmap done: 1 IP address (1 host up) scanned in 186.81 seconds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Nmap detects my python http server, and cockpit.</p>
<p>Alright, next I want to configure firewall usage. I don’t want the remote wireguard server to have access to everything on my “home” network. I am likely going to do this by creating vlan’s, which can be <a href="https://hobo.house/2016/03/10/build-secure-vlan-networks-with-shibby-tomato-router-firmware/">wifi</a>, by creating virtual wireless, or <a href="https://wiki.freshtomato.org/doku.php/advanced-vlan">ethernet</a>, by making it so that certain ethernet ports are trapped in a vlan. With this setup, I can ensure that my server is kept isolated from the rest of my devices, in case it gets compromised. (Although doing it this way is kinda pointless since I may be using a VPN on my devices, running through that same server to get around college wifi restrictions, if they exist).</p>
<p>So I setup wireguard on my server:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>/etc/wireguard/wg-stack.conf</strong></pre>
</div>
<div class="sourceCode" id="cb18" data-filename="/etc/wireguard/wg-stack.conf"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Interface]</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Address </span><span class="ot">=</span><span class="st"> 10.10.11.1/24</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="dt">PostUp </span><span class="ot">=</span><span class="st"> wg set %i private-key /etc/wireguard/%i.key</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="dt">ListenPort </span><span class="ot">=</span><span class="st"> </span><span class="dv">51000</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[Peer]</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># My router</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="dt">PublicKey </span><span class="ot">=</span><span class="st"> mFyQQk8/w7AhLSEtJKkcNhMNLPcyBMFHu02TI+OUj2Y=</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="dt">AllowedIPs </span><span class="ot">=</span><span class="st"> 10.10.11.0/24,192.168.17.0/24</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And here is the wg-stack.sh script that will be run on my router:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>wg-stack.sh</strong></pre>
</div>
<div class="sourceCode" id="cb19" data-filename="wg-stack.sh"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a># enabled by default</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>#echo 1 &gt; /proc/sys/net/ipv4/conf/br2/forwarding</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>#iptables -t nat -A POSTROUTING -o br2 -j MASQUERADE</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>#iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>modprobe wireguard</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>ip link add wg-stack type wireguard</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>wg setconf wg-stack /jffs/wg-stack-setconf</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>ip -4 address add 10.10.11.0/24 dev wg-stack</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>ip link set mtu 1420 up dev wg-stack</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>iptables -A FORWARD -i wg-stack -o br2 -j ACCEPT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some of the rules were enabled by default, so I commented them out.</p>
<p>And here is the wg-stack-setconf file that the above script calls upon:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>/jffs/wg-stack-setconf</strong></pre>
</div>
<div class="sourceCode" id="cb20" data-filename="/jffs/wg-stack-setconf"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Interface]</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="dt">PrivateKey </span><span class="ot">=</span><span class="st"> </span><span class="kw">NO</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Address = 10.10.0.0/24</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="dt">ListenPort </span><span class="ot">=</span><span class="st"> </span><span class="dv">51000</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[Peer]</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contabo VPS</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="dt">PublicKey </span><span class="ot">=</span><span class="st"> xO2fVY8uh4SDx5VH+24Mxx+WIXSnfY3Vw9CDBW7cMnY=</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="dt">AllowedIPs </span><span class="ot">=</span><span class="st"> 10.10.11.0/24</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="dt">Endpoint </span><span class="ot">=</span><span class="st"> &lt;VPS IP&gt;:51000</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="dt">PersistentKeepalive </span><span class="ot">=</span><span class="st"> </span><span class="dv">25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I have to manually specify the private key, because the <code>wg setconf</code> can’t run abitrary commands.</p>
<p>This works… one way.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>root@unknown:/jffs# ping 10.10.11.1</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>PING 10.10.11.1 (10.10.11.1): 56 data bytes</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>64 bytes from 10.10.11.1: seq=0 ttl=64 time=43.491 ms</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>root@unknown:/jffs# curl 10.10.11.1:8000</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"&gt;</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>&lt;html&gt;</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>....</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>.... I ran a simple http server to test if my router could see ports of my server.</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>....</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>&lt;/html&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, when my server attempts to ping or curl my router, it simply waits forever. I think this may have something to do with firewalll rules, where the router is refusing to respond to even ping connections.</p>
<p>After doing some more research, it appears my iptables rules deny all connections to my router, and I can attempt to access subnets other than my router itself, but they just redirect to my router:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>[root@vmi1403809 ~]# ping 192.168.17.152</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>PING 192.168.17.152 (192.168.17.152) 56(84) bytes of data.</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>64 bytes from 192.168.17.152: icmp_seq=1 ttl=63 time=41.9 ms</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>[root@vmi1403809 ~]# curl 192.168.17.152:8000</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>curl: (7) Failed to connect to 192.168.17.152 port 8000: No route to host</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>[root@vmi1403809 ~]# nmap -sV 192.168.17.152</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>Starting Nmap 7.91 ( https://nmap.org ) at 2023-08-19 20:18 PDT</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>Nmap scan report for 192.168.17.152</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>Host is up (0.043s latency).</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>Not shown: 999 filtered ports</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>PORT   STATE  SERVICE VERSION</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>22/tcp closed ssh</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>Nmap done: 1 IP address (1 host up) scanned in 5.53 seconds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The nmap scan is especially strange, considering I am using my laptop to test, which doesn’t have an ssh server running. My router however, does, but it also has an http server running (the web management interface), which nmap doesn’t seem to see. I am guessing my router is not playing the role of NAT properly.</p>
<p>Nope, I was wrong. The problem was not my router firewall, but rather my computer firewall. I forgot that unlike Arch Linux, the Arch Linux based linux distribution I was using, CachyOS did come with a firewall enabled.</p>
<p>After disabling the firewall:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>[root@vmi1403809 ~]# nmap -sV 192.168.17.152</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>Starting Nmap 7.91 ( https://nmap.org ) at 2023-08-20 03:21 PDT</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>Nmap scan report for 192.168.17.152</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>Host is up (0.042s latency).</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>Not shown: 999 closed ports</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>PORT     STATE SERVICE VERSION</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>8000/tcp open  http    SimpleHTTPServer 0.6 (Python 3.11.4)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>Nmap done: 1 IP address (1 host up) scanned in 7.78 seconds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For testing purposes, I run a simple http server using <code>python -m http.server</code> which launches this service in port 8000.</p>
<p>Alright, upon later investigation, it appears I was both right and wrong.</p>
<p>The <code>iptables -A FORWARD -i wg-stack -o br2 -j ACCEPT</code> only accepts <em>forwarded</em> packets, giving it access to devices in the br2 vlan, whereas input in the one that makes it respond to ping probes or show servcies. This is actually good, because my router won’t be exposed to my rented server, only the subnet behind it will. Without a policy to accept input packets, the router won’t even respond to ping probes.</p>
<p>However, I do have one final thing to handle:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>root@unknown:/jffs# ./wg-stack.sh </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>RTNETLINK answers: Network is unreachable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, when I run all the steps individually, this error doesn’t occur. This error occurs when I run the <code>ip link set mtu 1420 up dev wg-stack</code>, before the previous step in the script, assigning the ip address to the interface, isn’t done. I am guessing that the script runs too quickly, and some steps are run before the previous step is complete. I simply need to add a <code>sleep</code> command, which inserts an artificial wait in the process.</p>
<p>With all said and done, here is the script I have placed on my router:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>/jffs/wg-stack.sh</strong></pre>
</div>
<div class="sourceCode" id="cb25" data-filename="/jffs/wg-stack.sh"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>modprobe wireguard</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>sleep 2s</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>ip link add wg-stack type wireguard</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>sleep 2s</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>wg setconf wg-stack /jffs/wg-stack-setconf</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>sleep 2s</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>ip -4 address add 10.10.11.0/24 dev wg-stack</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>sleep 3s</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>ip link set mtu 1420 up dev wg-stack</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>sleep 2s</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>iptables -A FORWARD -i wg-stack -o br2 -j ACCEPT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And following the advice of the <a href="https://wiki.freshtomato.org/doku.php/wireguard_on_freshtomato#running_wireguard_at_boot">freshtomato wiki</a>, I have placed this script in the firewall section:</p>
<p><code>until [ $(ping -c 1 -A -W 5 -q google.com &amp;&gt;/dev/null &amp;&amp; echo 1 || echo 0) -eq 1 ]; do sleep 5; done; /jffs/wg-stack.sh</code></p>
<p>On my remote server, I can simply enable the wg-quick service</p>
<p><code>systemctl enable wg-quick@wg-stack</code></p>
<p>And now wireguard will be started automatically on both my router and the server.</p>
<p>Because my home server, is not accessible to the internet, I must proxy the connection through the contabo vps before I can get in. My ssh config uses the <code>ProxyJump</code> feature to proxy the connection from one vps into another.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>~/.ssh/config</strong></pre>
</div>
<div class="sourceCode" id="cb26" data-filename="~/.ssh/config"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>Host moontron</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                HostName VPS IP</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                port 22</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                user root</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                IdentityFile /home/moonpie/.ssh/moontron</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>Host moonstack</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>                Hostname 192.168.17.197</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>                port 22</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>                user root</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>                IdentityFile /home/moonpie/.ssh/moonstack</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>                ProxyJump moontron</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With this, I can ssh into my <code>moonstack</code> machine from anywhere in the world.</p>
<p>And because ansible can read the ssh config, I can simply plug the host nicknames into my ansible inventory, and my ansible can configure them, from anywhere in the world.</p>
</section>
<section id="vps-networking" class="level3">
<h3 class="anchored" data-anchor-id="vps-networking">VPS Networking</h3>
<p>Of course, this now makes my kolla-ansible installation more complex. Because I have now have two servers, to distribute to, and I also to deal with having to wireguard into my servers in order to be able to ssh into them.</p>
<p>Beyond that, I have switched from a single node installation, to a multi node installation.</p>
<p>Now that I have ssh and networking set up, I need to select the features and functions of my nodes.</p>
<p>Kolla-ansible sorts nodes into 4 types.</p>
<ul>
<li>Control: These run the dashboards, api and the like.</li>
<li>Networking: This runs the loadbalancers, virtual networking, and the like</li>
<li>Compute: VM’s and containers are hosted here</li>
<li>Storage: Various types of storage are on this node.</li>
</ul>
<p>From the the <a href="https://opendev.org/openstack/kolla-ansible/src/branch/master/etc/kolla/globals.yml">kolla-ansible globals</a>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a># This is the raw interface given to neutron as its external network port. Even</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    # though an IP address can exist on this interface, it will be unusable in most</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    # configurations. It is recommended this interface not be configured with any IP</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    # addresses for that reason.</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    #neutron_external_interface: "eth1"</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Based on this, it appears that if I attempt to use the singlular ethernet interface on my vps, then I will end up breaking my setup, as that ethernet interface will stop working normally.</p>
<p>I found something interesting on the <a href="https://docs.openstack.org/kolla-ansible/latest/reference/networking/neutron.html#example-shared-interface">openstack docs</a>. Apparently, this setup is possible, but “non trivial” to set up persistently, however, it is automated by Kayobe.</p>
<p>I went through <a href="https://docs.openstack.org/kayobe/latest/deployment.html">kayobe’s documentation</a>, and found a <a href="https://www.youtube.com/watch?v=teWgCm6Aq1c">youtube tutorial</a>, and the deployment looks to be much more complex than kolla-ansible, which is frustrating to discover.</p>
<p>Despite Kolla-ansible’s claims of creating a bridge interface and virtual ethernet’s persistently being “non-trivial”, I think they are easier to set up than the alternative options available me.</p>
<p>Both <a href="https://docs.openstack.org/project-deploy-guide/openstack-ansible/latest/">openstack-ansible</a>, and kayobe, simply aren’t as well documented. So it’s back to networking.</p>
<p>I found a <a href="https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking">useful article from Red Hat</a>, which is a very good overview of what virtual network interfaces I have available to me on a modern linux sysytem.</p>
<p>The two that it looks like I need to pick, are either macvlan, or bridge mode. Both of those modes allow you to create virtual ethernet interfaces</p>
<section id="macvtap" class="level4">
<h4 class="anchored" data-anchor-id="macvtap">Macvtap</h4>
<p>Because Rocky Linux uses networkmanager, I will use the nmcli tool to do stuff.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>nmcli connection add type macvlan dev enp1s0 mode bridge tap yes ifname macvtap0</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>....</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>ip a</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>....</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>4: macvtap0@enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 500</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    link/ether 56:19:3c:7a:b7:e5 brd ff:ff:ff:ff:ff:ff</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    inet 192.168.122.78/24 brd 192.168.122.255 scope global dynamic noprefixroute macvtap0</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>       valid_lft 3344sec preferred_lft 3344sec</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    inet6 fe80::2c2:9892:c942:1fec/64 scope link noprefixroute </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>       valid_lft forever preferred_lft forever</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This simply creates a device and all, which is able to get ip’s from the external world, and in this case, the parent ethernet interface can still be used normally.</p>
<p>You can disable automatic configuration of ipv4/v6 with</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>nmcli connection modify macvlan-macvtap0 ipv6.method "disabled"</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>nmcli connection modify macvlan-macvtap0 ipv4.method "disabled"</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Which I will probably need, as I won’t be paying for another ipv4 address.</p>
<p>The nice thing about using NetworkManager is that configuration using NetworkManager is persistent across reboots. Although I don’t want to jump to conclusions, it’s possible that “non-trivial to set up in a persistent manner” is based on older information.</p>
<p>I further expermimented with macvlan. Since openstack will probably be doing more advanced networking, I attempted to create another macvtap device with the parent being the already existing macvtap device. It got created, but it didn’t get internet access, nor did it automatically get it’s own ip address. I don’t know what this means when it comes to how openstack neutron will interact with it, as neutron may want to do something like that.</p>
<p>I found a <a href="https://desertislandit.wordpress.com/2016/02/08/neutron-a-flat-network-in-a-single-node-single-nic-openstack-environment-kilo-on-ubuntu-14-0-4/">wordpress blogpost</a> <a href="https://web.archive.org/web/20230824205310/https://desertislandit.wordpress.com/2016/02/08/neutron-a-flat-network-in-a-single-node-single-nic-openstack-environment-kilo-on-ubuntu-14-0-4/">archive</a>. In this blog, someone uses the openvswitch to create a bridge, in the necessary setup for neutron to be able to do stuff.</p>
<p>Based on what that setup looks like, it doesn’t look like neutron is given an interface that is a slave to the bridge, but it looks like an interface which is under the bridge is created for my machine to use normally, while neutron consumes the bridge itself for usage and creation of more virtual interfaces. However, this guide is for deploying openstack neutron on bare metal, and kolla-ansible works by deploying in docker containers.</p>
<p>I found <a href="https://docs.openstack.org/project-deploy-guide/openstack-ansible/newton/app-config-test.html">another relevant doc</a> on the openstack website, about using creating an all in one node using vlan’s, bridge interfaces. If I can figure out how do do this in networkmanager, I think it will actually work</p>
<p>The eth0.10 format creates a tagged vlan interface.</p>
<p>I found a relevant document <a href="https://docs.openstack.org/devstack/latest/guides/neutron.html">devstack with a single NIC</a>. Devstack is a way of testing openstack for development purposes and it seems that they’ve anticipated that people deploy openstack from devices like a laptop, which only have one NIC. Their method involves using Open vSwitch to create a bridge, making the main ethernet interface a slave to the bridge, and then configuring the bridge accordingly, giving the new slave an ip address, and using that.</p>
<p>However, I am still confused. The docs make it unclear: Do I give neutron a veth to use for it’s purposes, and use the bridge for network access, or do I give it the bridge, and use the veth created on the bridge to get internet connectivity for myself?</p>
<p>Based on the earlier linked devstack article, it looks like it’s not a linux bridge that’s created, but a openvswitch bridge that’s created, and then something akin to a veth is given to the host device to use for normal networking. However, kolla-ansible doesn’t seem to make this kind of setup too easy…</p>
<p>I did some testing, and I was able to add a macvtap interface on a veth interface.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>nmcli connection add type macvlan dev veth1 mode bridge tap yes ifname macvtap0 </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>Connection 'macvlan-macvtap0' (d2ea3d24-f831-4508-b2cf-c448e64afe2a) successfully added.</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>[moonpie@cachyos-x8664 moonpiedumplings.github.io]$ ip a</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>... irrelevant stuff omitted. </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>7: macvtap0@veth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 500</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    link/ether 66:4b:2e:a7:22:f2 brd ff:ff:ff:ff:ff:ff</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    inet 192.168.17.251/24 brd 192.168.17.255 scope global dynamic noprefixroute macvtap0</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>       valid_lft 86395sec preferred_lft 86395sec</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    inet6 fe80::5541:1541:5340:ebbc/64 scope link noprefixroute </span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>       valid_lft forever preferred_lft forever</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>[moonpie@cachyos-x8664 moonpiedumplings.github.io]$ curl google.com --interface macvtap0</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv="content-type" content="text/html;charset=utf-8"&gt;</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>&lt;TITLE&gt;301 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>&lt;H1&gt;301 Moved&lt;/H1&gt;</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>The document has moved</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>&lt;A HREF="http://www.google.com/"&gt;here&lt;/A&gt;.</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>&lt;/BODY&gt;&lt;/HTML&gt;</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>[moonpie@cachyos-x8664 moonpiedumplings.github.io]$ </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Putting a macvtap interface on a veth interface shows that veth interfaces are more versatile than macvtap interfaces, able to do things like allocate more ip address to sub interfaces.</p>
<p>So the next test is to see if I can put a bridge interface on a veth interface. If I can put a bridge interface on a veth interface, than openstack neutron can put a bridge interface on a veth interface, meaning I can simply give neutron a veth to consume.</p>
<p>I attempted to add a bridge with the veth1 interface as a port, but the bridge sits forever on “configuring ip”.</p>
<p>So based on this experimentation, it seems as if that linux bridge is used as the main one.</p>
<p>There doesn’t appear to be a way to use an existing linux bridge as neutron’s interface, at least not with kolla-ansible. But this does give me a funny idea: what if I install kolla-ansible, lose network connectivity, and then use VNC access to the VPS to finish the configuration manually?</p>
<p>I don’t think this would work though. I can’t guarantee that network connectivity will be maintained for the entirity of the setup, and if the connection was broken halfway through, then the entire thing could shatter.</p>
<p>Based on the <a href="https://docs.openstack.org/kolla-ansible/latest/reference/networking/neutron.html#openvswitch-ml2-ovs">kolla docs</a> and the <a href="https://github.com/openstack/kolla-ansible/blob/master/etc/kolla/globals.yml#L161">git repo</a>, it seems like kolla-ansible does support linuxbridge.</p>
<p>So I have two options: nested bridges, or setting up the main bridge and giving it to openstack, or somehow configuring the main openstack bridge in the middle of the install. I could modify the ansible playbooks to add the necessary veth interfaces in the middle of the install, but the issue is that kolla-ansible deploys everything in docker, and from a cursory look through, I can’t immediately figure out how to configure stuff outside the docker containers.</p>
<p>The next thing I will try is having a macvtap interface be a port of a bridge, as I haven’t tried that yet. If it works, I can play with the bridge, and see if I can do the veth interface trick, but rather than on a normal bridge, on a bridge that’s on a macvtap interface.</p>
<p>I did further testing with macvtap. On a debian libvirt virtual machine, using the NAT networking in order to make testing easy, I created a a macvtap interface and then plugged it into a bridge. However, it sat at “configuring ip” forever. But, if I manually assigned it an ip, then I could access it remotely, like from the host machine, from the bridges new ip, but I couldn’t do the reverse. Ping and curl, when asked to use that interface, didn’t work.</p>
<p>I am wondering if this is a firewall issue. Maybe packet forwarding by sysctl or iptables isn’t enabled?</p>
<p>I attempted to add a veth interface to the bridge that has macvtap as a port. Same as the bridge, dhcp and auto configuring ip didn’t work, but I could give it what I believed to be a static ip — except I couldn’t access this static ip, or send stuff through it.</p>
<p>A bridge under macvtap doesn’t appear to work fully.</p>
<p>What about a bridge under a bridge? I created a bridge, plugged a veth into it, and made the veth on the other end a port of a new bridge. Rather than let it sit on “configuring ip”, I gave it a static ip. Same issue… until I ran:</p>
<pre><code>root@debian:/home/moonpie# iptables -I DOCKER-USER -j ACCEPT
root@debian:/home/moonpie# curl google.com --interface bridge1
&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv="content-type" content="text/html;charset=utf-8"&gt;
&lt;TITLE&gt;301 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;301 Moved&lt;/H1&gt;
The document has moved
&lt;A HREF="http://www.google.com/"&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;
root@debian:/home/moonpie# </code></pre>
<p>In this case, bridge0 is my primary bridge, and bridge1 is the “bridge under the bridge”. I added an iptables rule to accept EVERYTHING, and it worked, making me think that the firewall is the issue for macvtap/lan as well.</p>
<p>I attempted to create a veth interface attached to the bridge interface, and I was suprised to see that it already got it’s own public ip. So apparently, it was iptables getting in the way. However, an iptables policy of “literally accept everything” isn’t very secure, so I need to isolate the necessary rules to have a nested bridge work.</p>
<p>I am guessing that it’s probably something related to packet forwarding, and I need to configure iptables to happily send the packets from a difference ip through the main bridge without touching them.</p>
<p>Alright, so after creating a macvtap interface, I realize something: it can send requests out, but I can’t actually access it.</p>
</section>
<section id="bridge-veth" class="level4">
<h4 class="anchored" data-anchor-id="bridge-veth">Bridge + Veth</h4>
<p>I experimented with bridges. Using cockpit’s networkmanager configuration allows you to seamlessly create a bridge which you can still use as a normal ethernet interface for some reason. It even preserves existing ip configuration. But gives me an unanswered question: If bridges are more featureful by default, and can also be used for normal connectivity, why not <em>always</em> use a bridge? More features are better, right?</p>
<p>Anyway, I was able to create a veth pair, enslave one to the bridge, and then the nonenslaved veth interface could be used as a normal ethernet interface.</p>
<p>Steps:</p>
<p>Use cockpit-networkmanager to create a bridge, and add the ethernet interface as a port.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>sudo ip link add veth0 type veth peer name veth1</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>sudo ip link set veth0 master br0</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>sudo ip link set veth0 up</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>sudo ip link set veth1 up</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>sudo nmcli connection add type ethernet ifname veth1 con-name veth1</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>sudo nmcli connection up veth1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And then that interface can be used normally. It got it’s own ip via dhcp from my router, and now my computer’s ethernet interface has two ip’s.</p>
<p>But this isn’t good enough for me. <code>ip</code> is not persistent (although it is scriptable, and I can rerun every boot), unlike NetworkManager configurations.</p>
<p>How can I create a veth interface using networkmanager?</p>
<p>I did some searching around, and it seems like at some point, <a href="https://networkmanager.dev/blog/networkmanager-1-30/">networkmanager added this option</a>. To create a veth interface, you must set the property, veth.peer when you create an interface.</p>
<p>So like so (tested and working)</p>
<p><code>nmcli con add type veth ifname veth0 con-name veth0 veth.peer veth1</code></p>
<p>And to add a veth interface to a bridge using nmcli:</p>
<p><code>nmcli connection add type bridge-slave ifname veth1 master bridge0</code></p>
<p>Nope, this doesn’t seem to work.</p>
<p>That creates a new connection, and breaks a lot. Now trying:</p>
<p><code>nmcli connection modify veth1 master bridge0</code></p>
<p>It didn’t work, because veth1 seems not to be managed by networkmanager.</p>
<p>Or alternatively, maybe I can create a veth already enslaved to a bridge.</p>
<p>I tried this <code>nmcli con add type veth ifname veth0 con-name veth0 peer veth1 master bridge0</code>, but it didn’t work because the wrong veth was added to the bridge. veth0 is added to the bridge, but veth1 is not managed by networkmanager. How can I create a veth interface with the unmanaged veth peer added to the bridge?</p>
<p>Or maybe I am going about this the wrong way. It appears I can force NetworkManager to manage interfaces by using (from <a href="https://old.reddit.com/r/linuxquestions/comments/jemh39/how_can_i_force_networkmanager_to_manage_a_veth/">this reddit post</a>):</p>
<p><code>nmcli device set $IFNAME managed yes</code></p>
<p>Once I do this, I can simply use cockpit to add the device to the bridge as a bridge member. And a reboot… and my veth1 device gets nuked.</p>
<p>So it seems I need to edit NetworkManager configurations to make it that the change is permanent.</p>
<p>But there might be an easier method. Looking at the udev rules:</p>
<div class="sourceCode" id="cb33" data-filenmae="/usr/lib/udev/rules.d/85-nm-unmanaged-rules"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>... (shorted for brevity)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a># Virtual Ethernet device pair. Often used to communicate with a peer interface</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a># in another net namespace and managed by libvirt, Docker or the like.</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a># Generally we don't want to mess with those. One exception would be the</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a># full system containers, like LXC or LXD. LXC containers run via libvirt</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a># don't use udev, so this doesn't apply. LXD does, though. To deal with the</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a># LXD situation, let's treat the devices called eth* as regular ethernet.</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>ENV{ID_NET_DRIVER}=="veth", ENV{INTERFACE}!="eth[0-9]*", ENV{NM_UNMANAGED}="1"</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These udev rules are set up in a way that veth devices named <code>eth*</code> will end up being managed by NetworkManager. This definitely seems exploitable.</p>
<p>So I do: <code>nmcli con add type veth ifname veth0 con-name veth0 veth.peer eth1</code></p>
<p>and sure enough, both interfaces are managed by NetworkManager. Using the web ui, I can add the “veth0” interface to the bridge, and it gets it’s own ip and everything. So what’s happening here?</p>
<p>By default, NetworkManager does not manage veth interfaces. But it does manage any interface it does create. When creating a veth interface using NetworkManager, it ends up being a weird scenario where only the main interface is managed, but the peer created is not, and I couldn’t do anything with it. But now I can.</p>
<p>I created a macvtap interface on top of the eth0 interface and it automatically get’s it’s own ipv4 address. I can curl using the –interface macvtap0 option, and I can access services hosting on this machine via the ip address this interface has.</p>
<p>In addition to all this, it persists past a reboot.</p>
<p>Now for the ultimate test: Nested bridging.</p>
<p>Steps (assuming <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/consistent-network-interface-device-naming_configuring-and-managing-networking">predictable network interface names</a> are enabled, because then the names eth0 and eth1 are unused):</p>
<ol type="1">
<li><p>Create eth0 via cockpit and enslave the singular “physical” interface to it using the ui.</p></li>
<li><p><code>nmcli con add type veth ifname veth1 con-name veth1 veth.peer eth1</code></p></li>
<li><p>add veth1 as a port to eth0 via cockpit.</p></li>
<li><p>Use cockpit to disable automatic ip addresses for your bridge, while keeping it enabled.</p></li>
</ol>
<p>And now you have two network interfaces. Now I will attempt to do this again, creating a bridge on another bridge.</p>
<p>And it works. <code>eth1</code>, gets internet access. I can also create a macvtap interface on the nested bridge, which works as I’d expect there as well.</p>
<p>This setup even persists a reboot.</p>
<p>Now?</p>
<p>To do it all again but with a naming scheme that doesn’t suck.</p>
<p>To do it all again, but with docker ipables rules getting in the way at the same time.</p>
<p>Or maybe I can use podman to deploy instead of docker?</p>
<p>I went through the docs and they say nothing. But the <a href="https://github.com/openstack/kolla-ansible/blob/375ecdde07e2bae25179b2454560389097f0573b/tools/validate-docker-execute.sh#L4">source code</a> does say something. In the <a href="https://github.com/openstack/kolla-ansible/blob/375ecdde07e2bae25179b2454560389097f0573b/tools/validate-docker-execute.sh#L4">container engine</a> part of the ansible configuration, there is an option to set what container engine is being used. This means I can set podman instead of docker.</p>
<p>However, this feels… A bit too far from standard practice. I will first see if I can get docker working.</p>
<p>Here is the iptables chains with docker installed:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>root@debian:/home/moonpie# iptables -L</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>Chain INPUT (policy ACCEPT)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>Chain FORWARD (policy DROP)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>DOCKER-USER  all  --  anywhere             anywhere            </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>DOCKER-ISOLATION-STAGE-1  all  --  anywhere             anywhere            </span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>DOCKER     all  --  anywhere             anywhere            </span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>ACCEPT     all  --  anywhere             anywhere            </span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>ACCEPT     all  --  anywhere             anywhere            </span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>Chain OUTPUT (policy ACCEPT)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>Chain DOCKER (1 references)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>Chain DOCKER-ISOLATION-STAGE-1 (1 references)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>DOCKER-ISOLATION-STAGE-2  all  --  anywhere             anywhere            </span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>RETURN     all  --  anywhere             anywhere            </span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>Chain DOCKER-ISOLATION-STAGE-2 (1 references)</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>DROP       all  --  anywhere             anywhere            </span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>RETURN     all  --  anywhere             anywhere            </span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>Chain DOCKER-USER (1 references)</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>RETURN     all  --  anywhere             anywhere            </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And here is the iptables rules without docker installed:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>root@debian:/home/moonpie# iptables -L</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>Chain INPUT (policy ACCEPT)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>Chain FORWARD (policy ACCEPT)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>Chain OUTPUT (policy ACCEPT)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Oh. That’s interesting. For whatever reason, docker takes the default forward policy of accept and throws it out the window. Why?</p>
<p>Since I will be using firewalld as my firewall while it is running, here are the iptables rules with firewall-cmd activated, but no docker:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>root@debian:/home/moonpie# iptables -L</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>Chain INPUT (policy ACCEPT)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>Chain FORWARD (policy ACCEPT)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>Chain OUTPUT (policy ACCEPT)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Uh oh. Shouldn’t firewall-cmd change the iptables default input and forward policy to drop? What’s going on here?</p>
<p>Okay, I’m going to forget the firewall for now. This is a bit too complex of an install.</p>
<p>I did more research, and kolla-ansible has a <a href="https://github.com/openstack/kolla-ansible/blob/df44a7fb16249e2e04b661aac82fb5b6b9f4dac9/doc/source/reference/deployment-and-bootstrapping/bootstrap-servers.rst">bootrstap</a> which happens before deploying openstack itself. This bootstrap phase does stuff like install docker. So my idea is to run the bootstrap phase before I configure the ethernet interfaces, so that everything is set up properly without docker interfering.</p>
<p>I attempted to do this, by creating a rocky linux virtual machine, and running the kolla all in one installation on it. Interestingly:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>ASK [openstack.kolla.baremetal : Set firewall default policy] *************************************************************************************************************************</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>skipping: [localhost]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>TASK [openstack.kolla.baremetal : Check if firewalld is installed] *********************************************************************************************************************</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>ok: [localhost]</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>TASK [openstack.kolla.baremetal : Disable firewalld] ***********************************************************************************************************************************</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>changed: [localhost] =&gt; (item=firewalld)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Kolla disables firewalld. I guess I don’t have to worry about that.</p>
<p>It gets most of the way through, but then fails at:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>ASK [openstack.kolla.docker : Write docker config] ************************************************************************************************************************************</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a> Blah blah blah, lots of python errors, they are always messy</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a> original message: Interface 'eth0' not present on host 'localhost'"}</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>``</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>So apparently, the bootstrap step of this does more than just install docker and disable firewall. Apparently it tries to actually configure the network interfaces. </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>So I am going to switch to set up "two" interfaces, make kolla believe that I have two, and then give them to docker. </span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>I created a bridge, called "eth0" and a veth attached to it called "eth1". </span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>By default, eth0 is the main interface, and eth1 is the neutron external interface. </span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>I run the bootstrap steps again, and it works without complaining. The prechecks don't complain as well. Now, it's time for the deployment. </span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>It goes all the way until:</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>```{.default}</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>RUNNING HANDLER [loadbalancer : Wait for haproxy to listen on VIP] *********************************************************************************************************************</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>fatal: [localhost]: FAILED! =&gt; {"changed": false, "elapsed": 300, "msg": "Timeout when waiting for :61313"}</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>PLAY RECAP *****************************************************************************************************************************************************************************</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>localhost                  : ok=61   changed=38   unreachable=0    failed=1    skipped=106  rescued=0    ignored=0   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Why did this fail? I’m guessing because I did not set the vip address in globals.yml, for high availability.</p>
<p>But I’m not creating a cluster rigth now, and my two node cluster won’t be able to use high availability either.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>/etc/kolla/globals.yml</strong></pre>
</div>
<div class="sourceCode" id="cb39" data-filename="/etc/kolla/globals.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This should be a VIP, an unused IP on your network that will float between</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the hosts running keepalived for high-availability. If you want to run an</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># All-In-One without haproxy and keepalived, you can set enable_haproxy to no</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># in "OpenStack options" section, and set this value to the IP of your</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 'network_interface' as set in the Networking section below.</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">#kolla_internal_vip_address: "10.10.10.254"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So I can disable high availibility, which I will do and try again.</p>
<p>Except I’ve encountered an issue when attempt to get this setup. Although eth1 works normally, eth0 (the bridge) will not send any requests. Curl or ping simply time out. However, even more strangely, I can still access cockpit via the ip address that it has setup.</p>
<p>For whatever reason, this bridge setup behaves different on debian vs on rocky linux. Even after a reboot, it still doesn’t work.</p>
<p>Change of plans. Rather than attempting to get away with the bridge also being able to act as a normal interface, I think I will just create two veths attatch them to a singular bridge which does not get an ip address.</p>
<p>So I create one bridge, create two veth pairs (eth1-veth1, and eth0-veth0), and attempt to curl using eth0. Nothing. I reboot. Same result.</p>
<p>What?</p>
<p>ip route:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>root@debian:/home/moonpie# ip route</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>default via 192.168.122.1 dev eth1 proto dhcp src 192.168.122.97 metric 101 </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>default via 192.168.122.1 dev eth0 proto static metric 425 </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>192.168.122.0/24 dev eth1 proto kernel scope link src 192.168.122.97 metric 101 </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>192.168.122.0/24 dev eth0 proto kernel scope link src 192.168.122.4 metric 425 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>[moonpie@rocky ~]$ ip route</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>default via 192.168.122.1 dev eth1 proto dhcp src 192.168.122.228 metric 101 </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>default via 192.168.122.1 dev eth0 proto static metric 425 </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>192.168.122.0/24 dev eth1 proto kernel scope link src 192.168.122.228 metric 101 </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>192.168.122.0/24 dev eth0 proto kernel scope link src 192.168.122.111 metric 425 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>iptables:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>[moonpie@rocky ~]$ sudo iptables -L</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>Chain INPUT (policy ACCEPT)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>Chain FORWARD (policy ACCEPT)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>Chain OUTPUT (policy ACCEPT)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination       </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>root@debian:/home/moonpie# sudo iptables -L</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>Chain INPUT (policy ACCEPT)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>Chain FORWARD (policy ACCEPT)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>Chain OUTPUT (policy ACCEPT)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>target     prot opt source               destination         </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Both have firewalls disabled. The only noticable difference between the two is the version of the linux kernel in use. Debian is using <code>Linux debian 6.1.0-11-amd64</code>, whereas rocky is using <code>Linux rocky 5.14.0-284.25.1.el9_2.x86_64</code>.</p>
<p>There are several things to test. The first is to test a different kernel version, because this could be a kernel bug, relating to linux bridges.</p>
<p>Another thing to test is if this is a networkmanager bug, so I could attempt to not use networkmanager to create bridges, and instead use ip.</p>
<p>So the first thing I try is a newer kernel. The <a href="http://elrepo.org/tiki/HomePage">ELrepo</a> is an unofficial repo for Red Hat Enterprise Linux (RHEL, or EL), and clones, like my rocky linux. The steps to add it are on the linked page.</p>
<p>Then, I nabbed the <a href="http://elrepo.org/tiki/kernel-ml"><code>kernel-ml</code></a> package, which is the latest stable mainline linux kernel. Now, my rocky linux virtual machine is using <code>Linux rocky 6.5.1-1.el9.elrepo.x86_64</code>.</p>
<p>And same thing.</p>
<p>So it’s probably not a kernel bug. Probably. The possibility that the RHEL, or the ELRepo kernel has some difference that causes this bug, is very low.</p>
<p>When looking at the cockpit page for networking, I see that eth0 (my bridge) is receiving data, but the sending data stays at 0. Strange.</p>
<p>It probably would have to be a difference between the network configuration between the two distros. Either networkmanager is configured differently by default, or there is a bug in the networking stack.</p>
<p>For example, in debian:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>/etc/NetworkManager/NetworkManager.conf</strong></pre>
</div>
<div class="sourceCode" id="cb44" data-filename="/etc/NetworkManager/NetworkManager.conf"><pre class="sourceCode ini code-overflow-wrap code-with-copy"><code class="sourceCode ini"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="dt">root@debian:/etc/NetworkManager# cat NetworkManager.conf </span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[main]</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="dt">plugins</span><span class="ot">=</span><span class="st">ifupdown,keyfile</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="kw">[ifupdown]</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># I changed this from false to true to force NetworkManager to manage every single thing, including the ethernet interface which it didn't do by default. </span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="dt">managed</span><span class="ot">=</span><span class="kw">true</span><span class="st"> </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On the other hand, rocky has everything in this file commented out.</p>
<p>And yup. When I change the relevant options in rocky’s NetworkManager.conf, it works now.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>/etc/NetworkManager/NetworkManager.conf</strong></pre>
</div>
<div class="sourceCode" id="cb45" data-filename="/etc/NetworkManager/NetworkManager.conf"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="dt">.....</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="dt">.....</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[main]</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Default is: </span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co">#plugins=keyfile,ifcfg-rh</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># commented out, of course. I added ifupdown and didn't remove ifcfg-rh, just in case it's needed, but it shouldn't be. </span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="dt">plugins</span><span class="ot">=</span><span class="st">keyfile,ifcfg-rh,ifupdown</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="kw">[ifupdown]</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="dt">managed</span><span class="ot">=</span><span class="kw">true</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="dt">.....</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="dt">....</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And it works now:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>[root@rocky moonpie]# ping google.com -I eth0 -c 1</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>PING google.com (142.250.72.174) from 192.168.122.111 eth0: 56(84) bytes of data.</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>64 bytes from lax17s50-in-f14.1e100.net (142.250.72.174): icmp_seq=1 ttl=113 time=4.81 ms</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>--- google.com ping statistics ---</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>rtt min/avg/max/mdev = 4.808/4.808/4.808/0.000 ms</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>[root@rocky moonpie]# ping google.com -I eth1 -c 1</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>PING google.com (142.250.72.174) from 192.168.122.150 eth1: 56(84) bytes of data.</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>64 bytes from lax17s50-in-f14.1e100.net (142.250.72.174): icmp_seq=1 ttl=113 time=14.9 ms</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>--- google.com ping statistics ---</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>rtt min/avg/max/mdev = 14.887/14.887/14.887/0.000 ms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Why does this work now?</p>
<p>Just kidding, this setup doesn’t survive a reboot. But it survives a reboot on debian?</p>
<p>Okay, I played around a little. The correct order is:</p>
<ol type="1">
<li>Edit NetworkManager.conf</li>
<li>Reboot</li>
<li>Then do bridge changes.</li>
<li>Reboot just to make sure they persist.</li>
</ol>
<p>And this persists beyond a reboot.</p>
<p>Now I will test an all in one installation on a virtual machine.</p>
<p>So I set it up… and same issue. I think I may need both a newer kernel, and the nmcli changes.</p>
<p>I install a newer kernel again, and it works. Wow. I think I may actually be encountering a bug. Fascinating.</p>
<p>But that’s besides the point. Now I will attempt to do an all in one installation of openstack using kolla ansible.</p>
<p>The main difficulty I am anticipating is the fact that installing docker changes the forward networking rules, from the default accept to a policy of drop.</p>
<p>But lucky me, that appears to be a debian thing. My network setup still works even after running the bootstrap step.</p>
<p>I even ran the pre run and the deploy steps, and they worked fine until I ran out of memory.</p>
<p>After adding more memory to the virtual machine, it worked:</p>
<p>After going to the <a href="https://docs.openstack.org/kolla-ansible/latest/user/quickstart.html#using-openstack">“Using Openstack”</a>, and running the post deploy steps to create an admin password, I have an openstack system:</p>
<p><img src="images/horizonlogin.jpg" class="img-fluid"></p>
</section>
</section>
</section>
</section>
<section id="deploying-and-using-openstack" class="level1">
<h1>Deploying and Using Openstack</h1>
<p>Edit: I later found another <a href="https://www.keepcalmandrouteon.com/post/kolla-os-part-1/">blog post</a> about deploying openstack with a veth and it seems they did many of the same steps I did.</p>
<p>I have no idea how to use this thing. I thought it would work similarly to proxmox, where I can just upload an iso and then go through the installation process. It seems to be more complex than that.</p>
<p>The first thing I did was attempt to create a network. It asked me for the physical network name, so I attempted to put “eth1” in that box. Apparently, you don’t put the physical interface there. The default physical interface for neutron is called “physnet1”. I put physnet1 there, and attempted to create an “instance” or virtaul machine with that network in use…</p>
<p>But adding that network was not an option. What?</p>
<p>Now that I got openstack set up in a virtual machine, I did a lot of experimenation with openstack. The first thing I did was to use kolla-ansible’s <a href="https://github.com/openstack/kolla-ansible/blob/da2d8e8b83e696795f4b9c774fc7e6787a1d700e/tools/init-runonce">init-runonce</a> script which creates an image for use with the cloud, and some demo networks.</p>
<p>However, for some reason, this init-runonce script creates the “public” network with the completely wrong ip subnet. It creates the public subnet with a 10.0.1.0/24, when in actuality, my public subnet is the libvirt default NAT subnet, 192.168.122.0/24.</p>
<p>I played a bit more with the init-runonce script, but nothing worked.</p>
<p>Eventually, I decided to create a provider network on my own. I first sourced <code>/etc/kolla/admin-openrc.sh</code> because this was the only way I could get openstack to authenticate properly.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>openstack network create --external --share \</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  --provider-physical-network physnet1 --provider-network-type flat \</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  libvirtnat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I then associated the correct subnet, and gateway in the ui. And voila, my virtual machine has internet access. One way. I can ping and curl google.com, but I can’t do the opposite.</p>
<p>The issue was security groups. By default, block all ingress traffic, but allow all egress traffic. By allowing icmp (ping packets) ingress traffic, I found that I could now ping the VPS I had created.</p>
<p>To allow all traffic, I can create a security group in the UI, with the “other protocol” selected, and the -1 wildcard on what protocol of traffic to accept. Now, I fully access my VPS.</p>
<p>On the other hand, I could also just disable firewall on all my VPS’s and use the security groups instead for granular control. Since you can have multiple security groups (what happens if they have conflicting rules?), maybe I could have security rules per service, and then just add an instance to security rules as needed.</p>
<p>Anyway, so now the other question I have: With provider networks, do I need to have the networking components and the compute components on the same node?</p>
<p>That would be the next thing to test. Thankfully, kolla-ansible has <a href="https://docs.openstack.org/kolla-ansible/latest/user/multinode.html">multinode</a> deployment instructions as well as single node.</p>
<p>The other thing I need to consider is how to set static ip’s for the virtual machines, from openstack itself. By default, <em>openstack</em> appears to take over the role of DHCP provider, meaning there is a chance that any ip’s it gets/sets for anything would conflict with my router.</p>
<p>To create an openstack subnet on my provider network, which uses the external dhcp server:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>openstack network set --no-dhcp libvirt-nat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb49"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>openstack subnet create --network libvirtnat --subnet-range 192.168.122.0/24 --gateway 192.168.122.1 libvirt-subnet</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>openstack port create --network libvirtnat --fixed-ip subnet=libvirt-subnet,ip-address=192.168.122.1 --disable-port-security dhcp-port</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But after I did this, I noticed something. Regardless of whether I had a port or a subnet used, the interface ip address did not match the actual ip address in use by the virtual machine. Openstack reporting the wrong ip address, but I could find the correct one by using nmap and scanning the entire libvirt nat subnet, or using <code>ip a</code> in the virtual machine.</p>
<p>Actually, I don’t even have internet acess when not using this port. For some reason, attempting to put a virtual machine on the public subnet, doesn’t give it any actual internet access.</p>
<p>I tried something else. In the cockpit networkmanager interface, I realized that I been simply leaving the eth1, the neutron external interface, still active, with an ip address, and everything. And other times, I had been disabling it entirely from networkmanager. Rather than disable it, I simply set just ipv4 and ipv6 addresses to disabled, while still keeping the little toggle in cockpit set to on.</p>
<p>With this setup, The ip adddress that openstack reported this instance getting, and the ip address on the instance itself matched.</p>
<p>Also, the subnet had dhcp enabled, using openstack’s dhcp to assign an ip address, from the reserved pool.</p>
<p>But this ip still isn’t static.</p>
<p>Except, maybe I don’t need to worry about that. I did some searching around, and on <a href="https://www.reddit.com/r/openstack/comments/10qcgq9/instance_gets_dhcp_from_external_source_neutron/j6psise/">reddit</a> someone mentioned how neutron port security rules prevent an openstack VM from gaining any ip other than the one it has been allocated.</p>
<p>So basically, each VM get’s a port on the subnet (and the port includes a mac address), and openstack’s dhcp server uses the mac address to give the same port the same ip address every time.</p>
<p>In order to avoid conflict between the</p>
<section id="monitoring" class="level2">
<h2 class="anchored" data-anchor-id="monitoring">Monitoring</h2>
<p>https://github.com/openstack-exporter/openstack-exporter</p>
</section>
<section id="cinder" class="level2">
<h2 class="anchored" data-anchor-id="cinder">Cinder</h2>
<p>Configuring cinder seems to require more than simply enabling the service, according to the <a href="https://docs.openstack.org/kolla-ansible/latest/reference/storage/cinder-guide.html">kolla-ansible docs</a>. I’ve selected the nfs storage backend, so I followed the instructions, but there is no nfs service available.</p>
<p><code>sudo dnf install nfs-utils</code> makes the service available to me.</p>
<p>And the docs are wrong, the name of the nfs system service is not nfs or nfsd, but actually:</p>
<p><code>systemctl enable --now nfs-server</code>, at least on rocky linux.</p>
<p>Cinder seems to be the volume mount feature that a minimal openstack install is missing. With it, I can do things like the volume mounts that I expected openstack to have by default.</p>
</section>
<section id="nova" class="level2">
<h2 class="anchored" data-anchor-id="nova">Nova</h2>
<p><a href="https://docs.openstack.org/nova/latest/">Main openstack doc for nova</a></p>
<section id="lxc" class="level3">
<h3 class="anchored" data-anchor-id="lxc">LXC</h3>
<p>Nova is one of the default services. By default, it uses libvirt to configure qemu + kvm. This is not satisfactory for me, since I have an nvidia gpu and it is a bit easier to use with containers, such as docker or lxc. Because I don’t have a “server” gpu, I won’t be able to get access to vgpu, a feature which enables you to split a gpu between multiple virtual machines.</p>
<p>However, it is possible to split a gpu between multiple containers even without any special features.</p>
<p>One interesting thing is that lxc and docker are just a frontend for a bunch of linux kernel features, so all you need is a supported kernel. According to the <a href="https://wiki.archlinux.org/title/Libvirt#Server">arch wiki</a> article for libvirt, you don’t need to install any lxc related tools to actually use libvirt with lxc, you simply point libvirt at the <code>lxc:///</code> connection. Note Arch linux doesn’t split packages, so everything libvirt needs is probably in one package. On ubuntu, for example, the <a href="https://docs.openstack.org/nova/latest/admin/configuration/hypervisor-lxc.html">openstack nova-lxc</a> article mentions how on ubuntu, another package is needed to be installed.</p>
<p>But is it even possible to configure a multi hypervisor openstack cloud? One <a href="https://www.reddit.com/r/openstack/comments/8hr93t/is_openstack_multihypervisor_configuration_kvm/dym7dtj/">reddit commenter</a> says no. In addition to that, the <a href="https://docs.openstack.org/nova/latest/configuration/config.html#libvirt.virt_type">libvirt_virt_type</a> is of the type “string” rather than the type “list”. This means that I would only be able to put one item here, either kvm or lxc.</p>
<p>One thing I could consider doing is running a privileged container on the main compute node, and then make it another compute node which another virtualization type.</p>
<p>The main issue with such a setup is how I would handle networking devices. If I run another container on the main compute node, then running it in privileged mode gives it access to <em>all</em> devices, which means all networking devices.</p>
<p>No wait, this isn’t actually an issue because I can just configure it so that the container uses different network interfaces. It will still see them, which might cause issues, but it won’t be using them.</p>
<p>So how can I run a privileged container with systemd?</p>
<p>I found a <a href="https://developers.redhat.com/blog/2019/04/24/how-to-run-systemd-in-a-container">relevant article</a> from Red Hat.</p>
</section>
<section id="gpu-passthrough" class="level3">
<h3 class="anchored" data-anchor-id="gpu-passthrough">GPU passthrough</h3>
<p>However, even if I do that, then</p>
<p><a href="https://docs.openstack.org/nova/latest/admin/pci-passthrough.html">PCI device passthrough</a></p>
<p>Based on this doc, it looks like I need to create flavors for virtual machines, which have the allocated gpu’s set up.</p>
<p>I may also want <a href="https://docs.openstack.org/kolla-ansible/latest/reference/compute/libvirt-guide.html#host-vs-containerised-libvirt">an external libvirt</a> daemon, because that may be easier to set up pci device passthrough and whatnot.</p>
<p>I found a <a href="https://www.reddit.com/r/openstack/comments/16g7lmj/kolla_ansible_pci_passthrough/">reddit post</a> where someone was asking for help about PCI passthrough with kolla-ansible, but no one has replied as of yet.</p>
<p>A few days later, they replied to their own post.</p>
<blockquote class="blockquote">
<p>Just in case anyone searches for this in the future: the file in /etc/kolla/config/nova needs to be named nova-compute.conf (NOT nova.conf) and then it will be added to the configuration.</p>
</blockquote>
</section>
</section>
<section id="zun-1" class="level2">
<h2 class="anchored" data-anchor-id="zun-1">Zun</h2>
<p>Zun is the container service. <a href="https://docs.openstack.org/kolla-ansible/latest/reference/compute/zun-guide.html" class="uri">https://docs.openstack.org/kolla-ansible/latest/reference/compute/zun-guide.html</a>.</p>
<p>Configuring this is pretty easy, but it should be noted that the user running kolla-ansible must be a member of the docker group, and I don’t know how to set that up before docker is installed, so you have to run bootstrap first, and then set up users and groups.</p>
<p>According to <a href="https://docs.openstack.org/zun/latest/configuration/policy.html">zun’s policy rules</a> it is not possible to create privileged containers by default. Also, <a href="https://blueprints.launchpad.net/zun/+spec/support-zun-create-privileged">Ubuntu’s launchpad</a> has something about this as well.</p>
<p>One thing I am thinking about is how to passthrough gpu’s and other things to containers. If I desire to do something like an AI trainig on docker containers (since a lot is done on kubernetes nvidia clusters), then I would end up using Zun for it.</p>
<p>I found an article in <a href="https://github.com/openstack/zun/blob/master/specs/pci-device-model.rst">zun’s git</a> saying that it was in the works, but that document is literally 5 years old…</p>
<p>I also found another <a href="https://blueprints.launchpad.net/zun/+spec/support-pcipassthroughfilter">6 year old document about zun</a>. In this doc, it says that pci passthrough has been implemented for zun.</p>
<p>Because the docs are unclear, I decided to go through the source code.</p>
<p>The source code for the <a href="https://github.com/openstack/zun/blob/master/zun/conf/pci.py">pci config options for zun</a></p>
<p>And here is the source code for the <a href="https://github.com/openstack/nova/blob/master/nova/conf/pci.py">pci config options for nova</a>.</p>
<p>Because they are the exact same thing, I am guessing I can use the configuration options <a href="https://docs.openstack.org/nova/latest/admin/pci-passthrough.html">here</a> and <a href="https://docs.openstack.org/nova/latest/configuration/config.html#pci.alias">here</a>.</p>
<p>Oh, I found something better. The <a href="https://docs.openstack.org/zun/latest/configuration/sample-config.html">sample zun configuration</a> has a pci passthrough options.</p>
<p>However, the zun step kept failing when I attempted to use kolla-ansible. Apparentlly the master’s release won’t be supporting zun for a while, because they have to update a lot of dependencies or something like that. Here is the <a href="https://github.com/openstack/kolla-ansible/commit/fdc3b122c1039d93190e68d925af21d459b4a4bf">git commit</a> with relevant changes.</p>
<p>Because of the above, I decided to switch to the 2023.1 release of kolla-ansible, rather than the master release, which it was probably a bad idea to be using.</p>
</section>
<section id="cyborg" class="level2">
<h2 class="anchored" data-anchor-id="cyborg">Cyborg</h2>
<p>Cyborg is management of “hardware acceletors”, like FGPA’s, or in my case, gpu’s.</p>
<p>The configuration is here:</p>
<p>However, given the ability to do PCI passthrough with zun and nova already, I don’t think I will need this service.</p>
</section>
<section id="skyline" class="level2">
<h2 class="anchored" data-anchor-id="skyline">Skyline</h2>
<p>Skyline is the next gen web ui for openstack. By default, only horizon, the older ui is installed.</p>
<p>According to this <a href="https://docs.openstack.org/skyline-console/latest/install/docker-install-ubuntu.html">doc</a> skyline serves on 9999 by default. But according to this <a href="https://docs.openstack.org/skyline-console/latest/configuration/skyline-console-settings.html">doc</a> skyline serves on port 8088 by default. But:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>nmap scan report for 192.168.122.111</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>Host is up (0.000092s latency).</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>Not shown: 990 closed tcp ports (reset)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>PORT     STATE SERVICE         VERSION</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>22/tcp   open  ssh             OpenSSH 8.7 (protocol 2.0)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>80/tcp   open  http            Apache httpd</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>3306/tcp open  mysql           MySQL 5.5.5-10.11.5-MariaDB-log</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>4567/tcp open  tram?</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>5000/tcp open  http            Apache httpd</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>8000/tcp open  http            Apache httpd</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>8022/tcp open  ssh             OpenSSH 8.7 (protocol 2.0)</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>9090/tcp open  ssl/zeus-admin?</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>9998/tcp open  distinct32?</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>9999/tcp open  http            nginx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since only 9999 is up, I decided to visit it, but it timed out.</p>
<p>I think the issue is that I’m running out of ram. It might also be CPU, but the monitoring reports that ram is full, although I have a lot of cpu leftover.</p>
</section>
<section id="magnum-1" class="level2">
<h2 class="anchored" data-anchor-id="magnum-1">Magnum</h2>
<p><a href="https://docs.openstack.org/kolla-ansible/latest/reference/containers/magnum-guide.html" class="uri">https://docs.openstack.org/kolla-ansible/latest/reference/containers/magnum-guide.html</a></p>
<p>Seems to be pretty simple to deploy. Needs an insecure option for autoscaling though, which doesn’t look too good.</p>
</section>
<section id="neutron" class="level2">
<h2 class="anchored" data-anchor-id="neutron">Neutron</h2>
<p>The documentation for configuring neutron using kolla-ansible is <a href="https://docs.openstack.org/kolla-ansible/latest/reference/networking/neutron.html">here</a>.</p>
<p>I want to enable provider networks for speed for the ipv4 subnet of my router, but I still don’t understand how neutron external subnets, and neutron networking in general works. The main question is this: Can I put virtual machines on an external subnet that is only available to a different networking node?</p>
<p>It should be possible.</p>
<p>To list the openstack physical networks, you can run:</p>
<p><code>openstack network agent list --agent-type L2 agent</code></p>
<p>To list L3 agents:</p>
<p><code>openstack network agent list --agent-type L3 agent</code></p>
<p>I am guessing I can just list all the agents at once.</p>
<p><code>openstack network set --binding:host_id=&lt;hostname&gt; &lt;network-name-or-ID&gt;</code></p>
<p>And to verify: <code>openstack network show &lt;network-name-or-ID&gt; -c binding:host_id</code></p>
<p>Just kidding, those commands were given by chatgpt and they fail. Running them returns:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>(venv) [root@thoth ~]# openstack network agent list --agent-type L2 agent</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>usage: openstack network agent list [-h] [-f {csv,json,table,value,yaml}] [-c COLUMN] [--quote {all,minimal,none,nonnumeric}] [--noindent]</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>                                    [--max-width &lt;integer&gt;] [--fit-width] [--print-empty] [--sort-column SORT_COLUMN] [--sort-ascending | --sort-descending]</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>                                    [--agent-type &lt;agent-type&gt;] [--host &lt;host&gt;] [--network &lt;network&gt; | --router &lt;router&gt;] [--long]</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>openstack network agent list: error: argument --agent-type: invalid choice: 'L2' (choose from 'bgp', 'dhcp', 'open-vswitch', 'linux-bridge', 'ofa', 'l3', 'loadbalancer', 'metering', 'metadata', 'macvtap', 'nic', 'baremetal')</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And just listing all agents (in my 2 node install with both with the same subnets):</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>(venv) [root@thoth ~]# openstack network agent list</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+--------------------+--------------+-------------------+-------+-------+---------------------------+</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>| ID                                   | Agent Type         | Host         | Availability Zone | Alive | State | Binary                    |</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+--------------------+--------------+-------------------+-------+-------+---------------------------+</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>| 2fb24192-27bc-4d4b-8263-cadc1a73c3b0 | DHCP agent         | network-node | nova              | :-)   | UP    | neutron-dhcp-agent        |</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>| 429b16e3-bd4f-4507-ae78-6336a12b6b87 | Open vSwitch agent | network-node | None              | :-)   | UP    | neutron-openvswitch-agent |</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>| f7e2987b-a6e6-4677-b627-9a32e0508dc9 | Metadata agent     | network-node | None              | :-)   | UP    | neutron-metadata-agent    |</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>| fd2a566d-1d47-470d-b0f6-49972b02813a | Open vSwitch agent | main-node    | None              | :-)   | UP    | neutron-openvswitch-agent |</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>| ffa989a0-42b4-4184-ba8d-72106ee32c89 | L3 agent           | network-node | nova              | :-)   | UP    | neutron-l3-agent          |</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+--------------------+--------------+-------------------+-------+-------+---------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a id="asking-for-help"></a></p>
<p>I did another install, an all in one node (including networking), and a network node. The all-in-one node has both interfaces on the libvirt NAT subnet, “default”, but the network node has it’s neutron external interface on a different libvirt NAT subnet.</p>
<p>Here is the networking agent list:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>(venv) [root@thoth ~]# openstack network agent list</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+--------------------+--------------+-------------------+-------+-------+---------------------------+</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>| ID                                   | Agent Type         | Host         | Availability Zone | Alive | State | Binary                    |</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+--------------------+--------------+-------------------+-------+-------+---------------------------+</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>| 07aa201f-08b6-4dc9-ac1c-98af105ad53e | L3 agent           | main-node    | nova              | :-)   | UP    | neutron-l3-agent          |</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>| 1afb9cd1-d1d0-4d59-ba58-f291868222da | Metadata agent     | network-node | None              | :-)   | UP    | neutron-metadata-agent    |</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>| 349bbed8-3526-4070-affe-a47c2bbe5985 | DHCP agent         | main-node    | nova              | :-)   | UP    | neutron-dhcp-agent        |</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>| 69b660b0-1bbc-4474-8668-71308486f3a8 | DHCP agent         | network-node | nova              | :-)   | UP    | neutron-dhcp-agent        |</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>| a62c5d36-8101-4ca3-8479-358657684273 | Metadata agent     | main-node    | None              | :-)   | UP    | neutron-metadata-agent    |</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>| b6221a20-3543-43c7-9a99-ce143a699702 | Open vSwitch agent | main-node    | None              | :-)   | UP    | neutron-openvswitch-agent |</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>| c0bb80a4-c9e7-48a9-a56a-5fa279bfcef0 | Open vSwitch agent | network-node | None              | :-)   | UP    | neutron-openvswitch-agent |</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>| d212772f-4996-413c-b8ef-c1e6b5442b22 | L3 agent           | network-node | nova              | :-)   | UP    | neutron-l3-agent          |</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+--------------------+--------------+-------------------+-------+-------+---------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>How can I ensure that the truly external network I create is attatched to a specific L3 agent?</p>
<p>Chatgpt says to use <a href="https://docs.openstack.org/neutron/latest/admin/ovn/availability_zones.html">availibility zones</a>.</p>
<p>However, one thing I am looking at that might be simpler is a multi regional deployment: <a href="https://docs.openstack.org/kolla-ansible/latest/user/multi-regions.html" class="uri">https://docs.openstack.org/kolla-ansible/latest/user/multi-regions.html</a></p>
<p>I also tried a <a href="https://docs.openstack.org/kolla-ansible/latest/user/multi-regions.html">multi regional</a> deployment. In addition to not working, giving me any kinds of zones to specify, chatgpt possible</p>
<p>I did some searching around and I found an <a href="https://github.com/openstack/kolla-ansible/blob/7186f960d93f2e523a2052acd0287e176f7ac927/ansible/group_vars/all.yml#L1132">interesting option in the ansible variables</a>.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a># Set OVN network availability zones</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>neutron_ovn_availability_zones: []</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, I am guessing that I need to enable OVN to use this, so I followed the <a href="https://docs.openstack.org/kolla-ansible/latest/reference/networking/neutron.html">kolla-ansible docs for this</a>.</p>
<p>I set the variable of neutron availibility zones to be edge, on my network only node, and main, on my main compute node. However, it seems like my variables were ignored:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>(venv) [root@thoth ~]# openstack network agent list</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+------------------------------+--------------+-------------------+-------+-------+----------------------------+</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>| ID                                   | Agent Type                   | Host         | Availability Zone | Alive | State | Binary                     |</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+------------------------------+--------------+-------------------+-------+-------+----------------------------+</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>| 1ca0eec3-22f3-4680-b4c6-2d6e97ab6b8b | DHCP agent                   | main-node    | nova              | :-)   | UP    | neutron-dhcp-agent         |</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>| 3f9fffd2-c3f7-4841-910e-bc73ba95ab53 | L3 agent                     | main-node    | nova              | :-)   | UP    | neutron-l3-agent           |</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>| 4a11630f-bbaf-4d8e-87d1-deb209e770fe | Open vSwitch agent           | main-node    | None              | :-)   | UP    | neutron-openvswitch-agent  |</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>| 820a9bbb-5279-4889-b511-979b1b7d327e | Open vSwitch agent           | network-node | None              | :-)   | UP    | neutron-openvswitch-agent  |</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>| bf317078-bf85-488c-87c3-026a23c8793b | L3 agent                     | network-node | nova              | :-)   | UP    | neutron-l3-agent           |</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>| e4e3d75b-55b5-4a1e-8bd2-632d8a37e5b9 | Metadata agent               | network-node | None              | :-)   | UP    | neutron-metadata-agent     |</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>| ec64e75e-0e61-434e-908f-e4b9d670adbc | DHCP agent                   | network-node | nova              | :-)   | UP    | neutron-dhcp-agent         |</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>| f5ea5528-e482-4609-ae33-09ef2d792b28 | Metadata agent               | main-node    | None              | :-)   | UP    | neutron-metadata-agent     |</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>| main-node                            | OVN Controller Gateway agent | main-node    | main              | XXX   | UP    | ovn-controller             |</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>| c484098d-fd7d-5d9c-81e5-be62657e571e | OVN Metadata agent           | main-node    | main              | XXX   | UP    | neutron-ovn-metadata-agent |</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+------------------------------+--------------+-------------------+-------+-------+----------------------------+</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>(venv) [root@thoth ~]# openstack availability zone list</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>+-----------+-------------+</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>| Zone Name | Zone Status |</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>+-----------+-------------+</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>| internal  | available   |</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>| nova      | available   |</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>| nova      | available   |</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>| nova      | available   |</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>| nova      | available   |</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>| main      | available   |</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>+-----------+-------------+</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>(venv) [root@thoth ~]# openstack availability zone list --network</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>+-----------+-------------+</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>| Zone Name | Zone Status |</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>+-----------+-------------+</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>| nova      | available   |</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>| nova      | available   |</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>| main      | available   |</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>+-----------+-------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And also, when I look in the UI, to create a network, it only lists the “nova” availibility zone hint.</p>
<p>What happened to my edge availability zone?</p>
<p>Anyway, I decided to do more searching. Apparently, the neutron_ovn_zones are set up <a href="https://github.com/openstack/kolla-ansible/blob/7186f960d93f2e523a2052acd0287e176f7ac927/ansible/roles/ovn-controller/tasks/setup-ovs.yml#L17">here</a>, which is ran as long as the host is a member of the <code>ovn-network-controller</code> group, which is a <a href="https://github.com/openstack/kolla-ansible/blob/master/ansible/inventory/multinode#L743">child of the “network” group</a>. Based on this, I don’t think I need to enable OVN in order to use OVN availability zones. It seems like some portion of OVN is deployed, but only the whole thing is used as a network backend if you enable it.</p>
<p>So because of this, I attempted to do another deployment with without setting OVN, but just availability zones.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>(venv) [root@thoth ~]# openstack network agent list</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+--------------------+--------------+-------------------+-------+-------+---------------------------+</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>| ID                                   | Agent Type         | Host         | Availability Zone | Alive | State | Binary                    |</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+--------------------+--------------+-------------------+-------+-------+---------------------------+</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>| 750d6eb8-a89b-495e-86ab-65a9235d963c | Open vSwitch agent | network-node | None              | :-)   | UP    | neutron-openvswitch-agent |</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>| 7921c839-1935-4d29-888d-8efae2f31aff | L3 agent           | main-node    | nova              | :-)   | UP    | neutron-l3-agent          |</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>| 7cb4df27-5d40-429d-816e-8336d7a9867c | Metadata agent     | network-node | None              | :-)   | UP    | neutron-metadata-agent    |</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>| ad40304b-b078-434d-bb6d-8e4087f7c7e1 | Open vSwitch agent | main-node    | None              | :-)   | UP    | neutron-openvswitch-agent |</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>| b9770fe2-6a6a-4f77-9c5e-c0b058eb6966 | L3 agent           | network-node | nova              | :-)   | UP    | neutron-l3-agent          |</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>| d02ba59c-cc43-4a5d-bff0-98bd3713ba53 | Metadata agent     | main-node    | None              | :-)   | UP    | neutron-metadata-agent    |</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>| e22251c8-053d-47a7-8980-0e17e2b15341 | DHCP agent         | network-node | nova              | :-)   | UP    | neutron-dhcp-agent        |</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>| f46c9a7d-d67b-49bf-9d7a-d9c268fd3229 | DHCP agent         | main-node    | nova              | :-)   | UP    | neutron-dhcp-agent        |</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>+--------------------------------------+--------------------+--------------+-------------------+-------+-------+---------------------------+</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>(venv) [root@thoth ~]# openstack availability zone list</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>+-----------+-------------+</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>| Zone Name | Zone Status |</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>+-----------+-------------+</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>| internal  | available   |</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>| nova      | available   |</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>| nova      | available   |</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>| nova      | available   |</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>| nova      | available   |</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>+-----------+-------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is even worse, now it didn’t even create the main availability zone.</p>
<p>On the <a href="https://docs.openstack.org/kolla-ansible/latest/reference/networking/neutron.html#example-multiple-interfaces">kolla-ansible docs for neutron</a>, it mentions that if you have multiple physical networks, you need to name them differently.</p>
<p>The <a href="https://docs.openstack.org/kolla-ansible/latest/user/multinode.html">multinode documention</a> details how to an ansible inventory to declare different variables for each service. Using this, I can replace change the physical interface names from physnet1 to something else. I am thinking physnet4 and physnet6, because of ipv4 and ipv6.</p>
<p>I tried changing the bridge name, however, nothing changed.</p>
<p>According to the <a href="https://github.com/openstack/kolla-ansible/blob/master/ansible/roles/neutron/templates/ml2_conf.ini.j2#L27">jinja2 template</a> which is used to generate the ml2-ini.conf</p>
<pre class="jinja2"><code>[ml2_type_flat]
{% if enable_ironic | bool %}
flat_networks = *
{% else %}
flat_networks = {% for interface in neutron_external_interface.split(',') %}physnet{{ loop.index0 + 1 }}{% if not loop.last %},{% endif %}{% endfor %}
{% endif %}</code></pre>
<p>The bridge names variable is completely ignored, and the flat_networks variable is generated purely from <code>neutron_external_interface</code> variable.</p>
<p>Although never directly stated, I think the docs are assuming that every network (and probably openstack, since neutron is also ran on the compute nodes) will have access to the exact same physical networks. However, in my setup, not every node will have access to the same networks. I think I have to use node-specific configurations to, to ensure that openstack understands that the physical network that my VPS has access to, and the one my server has access to, are not the same.</p>
<p>One thing I am thinking of trying is simply deploying openstack, editing <code>/etc/kolla/neutron-server/ml2_conf.ini</code>, and then rebooting, and seeing if that works. However, I don’t even now if this will actually work, so I will have to test.</p>
<p>Now I’ve encountered a problem: this file does not exist on the pure network node. It only exists on the main node. Is it possible to configure koll-ansible to deploy this folder to all nodes?</p>
<p>I found the exact <a href="https://github.com/openstack/kolla-ansible/blob/master/ansible/roles/neutron/tasks/config.yml#L167">playbook where the jinja2 template is deployed</a>. I then did some more hunting and found out when this exact playbook is ran, <a href="https://github.com/openstack/kolla-ansible/blob/7186f960d93f2e523a2052acd0287e176f7ac927/ansible/roles/neutron/tasks/config.yml#L162">when servers are in the neutron-server group</a>.</p>
<p>But after looking throught the multinode inventory, I realized that it’s not network nodes that are in the neutron-server group, but rather <a href="https://github.com/openstack/kolla-ansible/blob/master/ansible/inventory/multinode#L288C5-L288C5">only the control nodes</a>.</p>
<p>Based on this, it seems like that directory is purely for the control nodes, which run neutron-server, the API.</p>
<p>Because of this, I decided to add my network node to the neutron-server hosts, which resulted in this directory being created on the server. I then edited the file, but when I tried to create network with the physical net name <code>physnet2</code> I got an error.</p>
<p>I found another <a href="https://github.com/openstack/kolla-ansible/blob/f64c86de1ddec947b7c5cf9d262346d7f0d8fce4/ansible/roles/neutron/templates/openvswitch_agent.ini.j2#L18">config file</a>, where the bridges seem to map to physical network names. I edited this file:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>/etc/kolla/neutron-openvswitch-agent/openvswitch-agent.ini</strong></pre>
</div>
<div class="sourceCode" id="cb59" data-filename="/etc/kolla/neutron-openvswitch-agent/openvswitch-agent.ini"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[ovs]</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="dt">bridge_mappings </span><span class="ot">=</span><span class="st"> physnet2:br-ex</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But I still get the same error.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>(venv) [root@thoth kolla]# openstack network create --external --provider-physical-network physnet2 --provider-network-type flat public1</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>Error while executing command: BadRequestException: 400, Invalid input for operation: physical_network 'physnet2' unknown for flat provider network.</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>(venv) [root@thoth kolla]# openstack network create --external --provider-physical-network physnet1 --provider-network-type flat public1</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>+---------------------------+--------------------------------------+</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>| Field                     | Value                                |</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>+---------------------------+--------------------------------------+</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>| admin_state_up            | UP                                   |</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>| availability_zone_hints   |                                      |</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>| availability_zones        |                                      |</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>| created_at                | 2023-09-26T03:14:59Z                 |</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>| description               |                                      |</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>| dns_domain                | None                                 |</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>| id                        | 378f8457-c50f-4554-91cf-905d9ec08ac7 |</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>| ipv4_address_scope        | None                                 |</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>| ipv6_address_scope        | None                                 |</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>| is_default                | False                                |</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>| is_vlan_transparent       | None                                 |</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>| mtu                       | 1500                                 |</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>| name                      | public1                              |</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>| port_security_enabled     | True                                 |</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>| project_id                | 1e28ab734f2d45d986259ee44a54ff42     |</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>| provider:network_type     | flat                                 |</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>| provider:physical_network | physnet1                             |</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>| provider:segmentation_id  | None                                 |</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>| qos_policy_id             | None                                 |</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>| revision_number           | 1                                    |</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>| router:external           | External                             |</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>| segments                  | None                                 |</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>| shared                    | False                                |</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>| status                    | ACTIVE                               |</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>| subnets                   |                                      |</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>| tags                      |                                      |</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>| tenant_id                 | 1e28ab734f2d45d986259ee44a54ff42     |</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>| updated_at                | 2023-09-26T03:14:59Z                 |</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>+---------------------------+--------------------------------------+</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>(venv) [root@thoth kolla]# </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Although creating a network with the physical network <code>physnet1</code> works, <code>physnet2</code> doesn’t work.</p>
<p>But then, I did something that did work. I edited <code>/etc/kolla/neutron-server/ml2_conf.ini</code> on the <strong>main</strong> node, to contain <code>physnet1,physnet</code>. This worked, and then I could create a network with <code>physnet2</code>.</p>
<p>But if I put an instance on it, does it actually work? Well, I tried to create an image, and it failed but the openstack error is very vague. I have gotten this error due to not enough resources in the past, but based on some quick research, it can happen because of networks not being set up properly, either.</p>
<p>I decided to look at the logs:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>main-node:/var/logs/kolla/nova/nova-compute.log</strong></pre>
</div>
<div class="sourceCode" id="cb61" data-filename="main-node:/var/logs/kolla/nova/nova-compute.log"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>2023-09-26 09:48:40.783 7 ERROR nova.compute.manager [instance: 0ef0f1be-e4aa-4140-89af-4402f992f18b] nova.exception.PortBindingFailed: Binding failed for port ee3ee85b-6edf-4ace-a921-10fcca3637b3, please check neutron logs for more information.</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>....</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Well, that error is pretty explicit. What I am going to do is redeploy, but without the having two servers with the <code>neutron-server</code> role, and see if that works.</p>
<p>So I did the same thing, with only one neutron server, edited openvswitch.ini, and then attempted to create an instance on physnet2. It failed.</p>
<p>I then created a network on physnet1, and created an instance on that network. It worked, getting an ip which I could access externally and all. I could also do the same with a floating ip on that network, and it would get external internet access, and I could reach it externally. So at least I have this system halfway working.</p>
<p>Rather than attempting to put a virtual machine directly on an external network, I instead sought to allocate it a floating ip address. Same error.</p>
<p>I decided to search the configuration directories for more related to this:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>[root@main-node /etc/kolla]# find . -type f -exec grep -H 'physnet' {} +</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>./neutron-server/ml2_conf.ini:flat_networks = physnet1,physnet2</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>./neutron-openvswitch-agent/openvswitch_agent.ini:bridge_mappings = physnet1:br-ex</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>[root@network-node /etc/kolla]# find . -type f -exec grep -H 'physnet' {} +</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>./neutron-openvswitch-agent/openvswitch_agent.ini:bridge_mappings = physnet2:br-ex</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So I can’t be missing a config file, since find seems not to find anything but those two files that I already edited.</p>
<p>So, I decided to do something that I probably should have done from the very beginning: I decided to test with a sole network node, with the main node no longer having that role.</p>
<p>And it didn’t work. I’m not sure yet, but I’m guessing that the default method I was attempting to use for external network interfaction, provider networks, requires that the virtual machine be on the same host as the network is one, since it works by giving virtual machines direct physical access to networks.</p>
<p>What I did, that works (mostly from <a href="https://github.com/openstack/kolla-ansible/blob/master/tools/init-runonce">init-runonce</a>, the sample setup script):</p>
<ol type="1">
<li><code>openstack network create --external --provider-physical-network physnet1 --provider-network-type flat public1</code></li>
</ol>
<ul>
<li>or just do it from the UI, create a flat network with the name, physnet1</li>
</ul>
<ol start="2" type="1">
<li>In the horizon UI, give this subnet the proper options. That’s way easier than trying to edit the command given by init-runonce.</li>
<li><code>openstack network create demo-net</code></li>
</ol>
<ul>
<li>Create a subnet in the horizon UI</li>
</ul>
<ol start="4" type="1">
<li><code>openstack router create demo-router</code></li>
<li><code>openstack router add subnet demo-router demo-subnet</code></li>
<li><code>openstack router set --external-gateway public1 demo-router</code></li>
</ol>
<ul>
<li>Note: according to <a href="https://github.com/openstack/kolla-ansible/blob/master/tools/init-runonce#L131">init-runonce</a>, the command is different for ipv6 external networks.</li>
</ul>
<p>Then, you can create an instance on that internal subnet. After the instance is created, you should be able to allocate it a floating ip address. When security groups were set up properly, I could ping and nmap it.</p>
<p>However, I encountered a hiccup already: The virtual machine does not see it’s ip address, and cannot bind to it for stuff. But that’s a problem for after I verify that this setup works on my full, two network node setup.</p>
<p>I attempted to set it up this way, but unlike my single network node setup, my virtual machine has no internet access. In addition to that, the floating ip cannot be accessed externally (no ping or nmap).</p>
<p>At this point, I am very confused, so I decided to send an email to the <a href="https://wiki.openstack.org/wiki/Mailing_Lists">openstack mailing list</a>.</p>
<p>I searched first, and I found <a href="https://lists.openstack.org/pipermail/openstack-discuss/2022-December/031522.html">a scenario similar to mine</a>. This person had an issue where, when they tried to add more bridges after they have already been deployed, using kolla-ansible’s reconfigure feature and editing the kolla yaml files. Although not the same to my situation, I will look at the logs and see if I am getting similar errors, or the like.</p>
<p>A few days later, I changed nothing except for updating the kolla-ansible deployment scripts (I recreated the venv). And it worked.</p>
<p><img src="images/networkingworking.jpg" class="img-fluid"></p>
<p>I can use floating ip’s to put virtual machine’s on the network located on the network-node.</p>
<p>Now, at first there was an error when I attempted to put the virtual machine directly on the provider network, but then I changed that network to be a “shared” network and it worked. I think this is what I was missing when I attempted to do it originally, but there are too many variables for me to be able to isolate properly.</p>
<p>Anyway, now I can do both provider and floating ip on the main node. Provider networks are more performant, apparently.</p>
<p>However, one reddit user says that <a href="https://www.reddit.com/r/openstack/comments/zkogoe/ipv6_is_not_working_when_ml2_port_security_is/">ipv6 does not work when port security is enabled</a>. I need to investigate this more closely.</p>
<section id="ipv6" class="level3">
<h3 class="anchored" data-anchor-id="ipv6">IPv6</h3>
<p>I began to test to see if I could create an ipv6 floating ip:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>(venv) [root@intmain-node ~]# openstack floating ip create public1</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>Error while executing command: BadRequestException: 400, Bad floatingip request: Network d5eaee4c-5a21-48f6-8b7b-a73f956bbeb9 does not contain any IPv4 subnet.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Acording to the <a href="https://docs.openstack.org/neutron/latest/admin/config-ipv6.html#nat-floating-ips">docs</a>, floating ip addresses do not support ipv6.</p>
<p>I asked around, and apparently, you are supposed to use <a href="https://docs.openstack.org/neutron/latest/admin/config-subnet-pools.html">subnet pools</a> for this.</p>
<p>I first attempted to create one with my libvirt nat subnet:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>(venv) [root@intmain-node ~]# openstack subnet pool create --share --pool-prefix fd00::0/8  --default-prefix-length 8 demo-subnetpool6</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>BadRequestException: 400: Client Error for url: http://192.168.124.112:9696/v2.0/subnetpools, Illegal prefix bounds: default_prefixlen=8, min_prefixlen=64.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Apparently, openstack doesn’t support prefix lengths smaller than /64. That’s perfectly ok, as my “production” deployment will have that subnet. But my libvirt nat subnet, I made it a /8, which probably wasn’t a good idea.</p>
<p>I later changed my libvirt subnet to be smaller, but the subnet pools appeared to behave similarly to normal subnets, with me not being able to put a virtual machine on the remote network.</p>
<p>Chatgpt suggests that I do a more complex setup, where I basically create a physical network, subnet pool, and then allocate a portion of that subnet pool to a non-external network? I recorded the commands it gave so I can replicate them:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>openstack subnet pool create --default-prefix-length &lt;Prefix_Length&gt; --pool-prefix &lt;CIDR&gt; --name external-pool</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>openstack network create --external --provider-network-type flat --provider-physical-network &lt;Physical_Network&gt; --provider-segment &lt;Segment_ID&gt; external-net</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>openstack subnet create --network external-net --subnet-pool external-pool --no-dhcp external-subnet</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>openstack network create my-project-net</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>openstack subnet create --network my-project-net --subnet-pool external-pool my-project-subnet</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>openstack server create --flavor &lt;Flavor&gt; --image &lt;Image&gt; --nic net-id=my-project-net my-vm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I was attempting to do this from the UI, where I noticed that there was now an option to create a subnet from an existing pool, rather than specifying a number. But It fails with:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a> Error: Failed to create subnet "None" for network "demo-sixnet". Details</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>Failed to allocate subnet: Cannot allocate requested subnet from the available set of prefixes. Neutron server returns request_ids: ['req-dccfaaae-c4e6-4bbc-99cc-3e5a9a49a467']</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I don’t know why this happens yet. I tried with both a /64, which is the same as the subnet above, and several smaller values, like /128, the smallest it would let me work with, and it still failed.</p>
<p>I found an interesting <a href="https://superuser.openinfra.dev/articles/disable-nat-ipv4-openstack/">article from the openinfra blog</a> (<a href="https://web.archive.org/web/20231015073139/https://superuser.openinfra.dev/articles/disable-nat-ipv4-openstack/">archive</a>) about how to disable NAT for the ipv4 subnets, but it appears to be written for the older openstack, before the unified cli.</p>
<p>According to the blog, however, it says that the address scopes are <em>mandatory</em> if you want to have this setup. Here are the <a href="https://docs.openstack.org/mitaka/networking-guide/config-address-scopes.html">mikata (older release)</a>, and here are the <a href="https://docs.openstack.org/neutron/latest/contributor/internals/address_scopes.html">latest</a> docs from the openstack docs.</p>
<p>Based on the address scope guide, I tried following that. But when I get to one of the later steps:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>(venv) [root@intmain-node ~]# openstack subnet create --ip-version 6 --ipv6-ra-mode slaac --ipv6-address-mode slaac --subnet-pool subnet-pool-ip6 --prefix-length 128 --network network2 subnet-ip6-2</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>HttpException: 500: Server Error for url: http://192.168.124.112:9696/v2.0/subnets, Failed to allocate subnet: Insufficient prefix space to allocate subnet size /128.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Both /64 and /128 give me the same error. On one hand, I want to increase the size of my libvirt subnet, however, then that would not be representative of my real scenario, where I will only have a /64 subnet.</p>
<p>Linked in the address scopes doc, is a <a href="https://www.youtube.com/watch?v=j5hy11YlSOU">video</a>. That video is not very helpful, but in links to it’s <a href="https://www.slideshare.net/eyepv6/deploying-ipv6-in-openstack-environments">presentation</a>, hosted on a site called slideshare. Slideshare recommends similar presentations, and I saw two others, <a href="https://www.slideshare.net/ritchey98/openstack-neutron-ipv6-lessons">this one</a>, and <a href="https://www.slideshare.net/vietstack/deploying-ipv6-on-openstack">this one</a>.</p>
<p>Both articles mention that with SLAAC (what is slaac?), only a /64 prefix is used.</p>
<p>Anyway, I still lack understanding of why this is ahppenign. Maybe a /64 is the minimum size I can allocate? But then why would the UI have options for smaller subnet sizes? Anyways, I am going to test it out by chaging my libvirt subnet to be something bigger, like a /56.</p>
<p>I attempted to upsize my subnet to a /64, but I kept getting an error. The error was somethign about dnsmasq (dhcp server), and it requiring a minimum subnet prefix size of /64. I turned off dhcpv6, and only then was I able to create an ipv6 /56 subnet. Only tangentally related, but maybe the openstack is having a similar issue?</p>
<p>I tried creating a subnet with dhcp disabled, same issue.</p>
<p>Another thing I will attempt to experiment with is working with ports directly. I might be able to create a port on a subnet, and directly attatch it to a virtual machine.</p>
<p>I attempted to connect a port from the ipv6 subnet to a virtual machine directly:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode default code-overflow-wrap code-with-copy"><code class="sourceCode default"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible. &lt;class 'nova.exception_Remote.PortBindingFailed_Remote'&gt; (HTTP 500)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I will have to investigate the logs futher, but I suspect that it simply isn’t possible to allocate ports to machines that aren’t on the same network.</p>
<p>Another person mentioned how they used <a href="https://docs.openstack.org/neutron/latest/admin/config-bgp-dynamic-routing.html">BGP</a> to get this working, but I don’t know what BGP is. It seems this setup requires address scopes.</p>
<p>I spent some time talking on discord (did I link the openstack discord here?). I was told it’s not possible, by someone who seems pretty knowledgable. They said that with ipv6, devices are expected, and recommended to have a unique ip address. Link to <a href="https://datatracker.ietf.org/doc/html/rfc5902">relevant doc</a>.</p>
<p>However, I still find this hard to believe, since some <a href="https://blogs.infoblox.com/ipv6-coe/you-thought-there-was-no-nat-for-ipv6-but-nat-still-exists/">blog posts</a>, mention the existance of an ipv6 nat.</p>
<p>I have a new idea: the router has a subnet, and this subnet is exposed via a vpn. Packets are forwarded to this subnet. Because this subnet is located on the same physical node, there is no need to worry about the more compex pieces of openstack networking.</p>
<p>One reddit user <a href="https://www.reddit.com/r/WireGuard/comments/lwkksi/using_ipv6_from_a_vps_provider_in_my_home_network/">says that this is possible if ebtables are disabled</a>.</p>
<p>Okay, later the person I was talking to on discord mentioned that it is indeed possible, but not with NAT, but instead with BGP.</p>
<blockquote class="blockquote">
<p>Yes as the flow will be: ipv6 address X is on node A but to reach it you need to contact me router A (on network node).</p>
</blockquote>
<p>I asked what to search for since docs aren’t too good, and they said:</p>
<blockquote class="blockquote">
<p>Openstack neutron OVN/OVS BGP north/south traffic ipv6 🙂 Should give you plenty documentation.</p>
</blockquote>
<p>I asked further about doing this with just OVS, since OVN seems to add more complications and is not enabled by default in kolla-ansible.</p>
<blockquote class="blockquote">
<p>OVN is still OpenVSwitch but with a different approach and structure, thought about it as OVS 2.0.</p>
</blockquote>
<blockquote class="blockquote">
<p>And yes you can achieve what you want with OVS instead of OVN.</p>
</blockquote>
<p>From the openstack docs: <a href="https://docs.openstack.org/neutron/2023.1/admin/config-bgp-floating-ip-over-l2-segmented-network.html" class="uri">https://docs.openstack.org/neutron/2023.1/admin/config-bgp-floating-ip-over-l2-segmented-network.html</a> but it seems to mainly apply to ipv4.</p>
<p>Also: <a href="https://docs.openstack.org/neutron/latest/admin/config-bgp-dynamic-routing.html" class="uri">https://docs.openstack.org/neutron/latest/admin/config-bgp-dynamic-routing.html</a></p>
<p><a href="https://www.youtube.com/watch?v=yUOsN2ka1Gk">Youtube video</a>, and the slides are <a href="https://object-storage-ca-ymq-1.vexxhost.net/swift/v1/6e4619c416ff4bd19e1c087f27a43eea/www-assets-prod/presentation-media/20170508-IPv6-Lessons.pdf">in pdf here</a></p>
<p>I also desire to enable vpn-as-a-service. But <a href="https://docs.openstack.org/kolla-ansible/latest/reference/networking/neutron-extensions.html#neutron-vpnaas-vpn-as-a-service">according to the docs</a>, that’s not too difficult to set up.</p>
</section>
</section>
<section id="multi-node-install" class="level2">
<h2 class="anchored" data-anchor-id="multi-node-install">Multi Node Install</h2>
<p>A multi node install is documented here: <a href="https://docs.openstack.org/kolla-ansible/latest/user/multinode.html" class="uri">https://docs.openstack.org/kolla-ansible/latest/user/multinode.html</a></p>
<p>For convinience purpose, I will have my inventory git tracked, in the same repo as my blog.</p>
<p>One thing I am confused about, is where does the globals.yml file go? In the all in one installation, it goes on the single server, which you both deploy from, and to. But if I am deploying to a different machine, do I put this file on the machines I am deploying to, or the machines I am deploying from?</p>
<p>The other thing I am concerned about is how virtual machines will interact to being on a different node than the primary networking node. If I have a compute node, which doesn’t have access to an external subnet, and a networking node that does, then can I have a virtual machine on the external subnet that only the networking node has access to?</p>
<p>I have created multiple machines and an ansible inventory.</p>
<p>But apparently, the deployment host actually is configured a bit, since I got this error:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>fatal: [localhost]: FAILED! =&gt; {</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    "assertion": "ansible_facts.distribution in host_os_distributions",</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    "changed": false,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    "evaluated_to": false,</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    "msg": "Host OS distribution Archlinux is not supported. Supported distributions are: CentOS, Debian, openEuler, Rocky, Ubuntu"</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I decided to ignore this and power through anyways.</p>
<p>However, for the post deploy step, I needed to create the /etc/openstack directory and chown it to user so that sudo permissions aren’t needed to modify it.</p>
<p>Also, based on my testing, the globals.yml file goes on the deployment host.</p>
<p>So I deployed a two node openstack install, and I attempt to create a virtual machine, but I get an error. It’s one of those incomprehensible python errros, but after looking at my virtual machine, they appear to be out of ram.</p>
<p>This is weird, because I don’t think I have anything enabled but the core openstack services. Currently, I have just two vps’s, a network node with 3 GB of ram and a compute node with 6 Gb of ram.</p>
<p>Because of the ram usage, I can’t properly test. In order to get more ram, I decided to install libvirt on my “moonstack”, which is going to be the openstack compute node. I find this highly ironic (and not the openstack component), since I am basically setting up my server to run virtual machines in an easier manner to prototype for doing so in a harder manner.</p>
<p>Using a combination of cockpit-machines, ssh proxy jumping, and virt-manager’s ability to manage a remote I managed to deploy an all in one, and a network node. Besides the default services, I also enabled magnum, zun (and kuryr, container networking), and cinder (via nfs).</p>
<p>Here is the memory usage for both nodes:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>[root@network-node ~]# free -m</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>               total        used        free      shared  buff/cache   available</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>Mem:            7486        2190        2105          15        3538        5295</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>Swap:           7883           0        7883</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb71"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>[root@main-node ~]# free -m</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>               total        used        free      shared  buff/cache   available</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>Mem:            7486        6816         273          61         857         669</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>Swap:           7883          77        7806</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Good. The network node seems to have ample free space, meaning all of my fancy networking will fit just fine on my 8 GB of ram VPS.</p>
<p>The main node seems to be a little… strangled, but 8 GB is nothgin compared to the 128 GB teh actual install will have.</p>
<p>Now I need to test openstack network interactions.</p>
<p>I upgraded the main node to have 16 GB of ram, and I did an all in one installation + a network node. The network node has a second virtio interface, which is attatched to a different NAT subnet. The point of this is to test how openstack networking works when not all network nodes have their neutron external interfaces on the same subnet.</p>
<p>Ram usage:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>[root@network-node ~]# free -m</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>               total        used        free      shared  buff/cache   available</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>Mem:            7486        2198        2102          14        3532        5287</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>Swap:           7883           0        7883</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>[root@main-node ~]# free -m</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>               total        used        free      shared  buff/cache   available</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>Mem:           15350        8221         558          90        7025        7129</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>Swap:           7883           1        7882</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="ipv6-on-contabo" class="level2">
<h2 class="anchored" data-anchor-id="ipv6-on-contabo">Ipv6 on Contabo</h2>
<p>More vps networking, I can’t believe it.</p>
<p>As I get closer to a deployment, I need to make sure that I have the ipv6 addresses available.</p>
<p><a href="https://contabo.com/blog/ipv6-now-available-for-all-our-customers/" class="uri">https://contabo.com/blog/ipv6-now-available-for-all-our-customers/</a></p>
<p>According to this article, contabo makes an entire /112 range of ipv6 addresses avaiable to their customers by default. That’s 65535 ip addresses.</p>
<p>Except this article seems to be outdated.</p>
<p>According to <a href="https://contabo.com/en/customer-support/faq/#how-can-i-use-ipv6-on-my-server-at-contabo">a newer FAQ</a>, the range seems to be /64.</p>
<p><a href="https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/" class="uri">https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/</a></p>
<p>According to the above article, contabo has already added ipv6 support, and you simply look at the vps control page to see your available ipv6 address. However, there is no such box on my vps control page.</p>
<p>I think this may have something to do with the fact that campus internet is not ipv6 capable, so maybe there is no need to show it to me since I would not be able to access it.</p>
<p>Or it could do with the fact that this article is from 2013 and possible wildly out of date.</p>
<p>However, on the reverse DNS page, my vps’s ipv6 address is shown:</p>
<p><img src="images/ipv6.png" class="img-fluid"></p>
<p>So, inferring from that, I can tell that my vps’s ipv6 address is “2605:a141:2140:3809:0000:0000:0000:0001”. And if I get a /64 range, then I can tell my range is 2605:a141:2140:3809::/64. Of course, that’s not enough, I also need to know the default gate way for this network… The article above details it for a different subnet, but I don’t know for my own subnet.</p>
<p>There is a command, <code>enable_ipv6</code> which comes out of the box on the contabo servers, but it doesn’t do anthing:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>[root@vmi1403809 ~]# which enable_ipv6</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>alias enable_ipv6='sed -i "/net.ipv6.conf.all.disable_ipv6.*/d" /etc/sysctl.conf &amp;&amp; sysctl -q -p &amp;&amp; echo 0 &gt; /proc/sys/net/ipv6/conf/all/disable_ipv6'</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>        /usr/bin/sed</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>        /usr/sbin/sysctl</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>        /usr/bin/echo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>All it does is change the sysctl parameters to enable ipv6, and it doesn’t actually set it up. Without knowing my default gateway, nothing I do with ipv6 will be able to access the internet.</p>
<p>Using cockpit and networkmanager, I set my ipv6 address to what was above. The default gateway was fe80::1, which was noted <a href="https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/">here</a>. I tried to ping it and nmap it but I diddn’t see anything.</p>
<p>For DNS, rather than using contabo’s DNS, I decided to go for google’s two public ipv6 dns’s, <code>2001:4860:4860::8844</code>, and <code>2001:4860:4860::8888</code>. These are noted on <a href="https://developers.google.com/speed/public-dns/docs/using">google’s developer docs</a>.</p>
<p>Sure enough, when I proxy into my server (I used ssh with the -D option), and go to <a href="https://test-ipv6.com/" class="uri">https://test-ipv6.com/</a> I get this result:</p>
<p><img src="images/serveripv6.jpg" class="img-fluid"></p>
<p>My server has a public ipv6 address now. And if I can give this interface a public ipv6 address, then openstack will definitely be able to give any virtual interfaces it creates public ipv6 addresses.</p>
<p>Later, I realized that the way openstack allocates floating ip addresses, is by contacting an external dhcp server, so I have to create my own dhcp server.</p>
<p>In addition to that, if I want to access the ipv6 services from my VPS, then I will need to have an ipv6 address configured.</p>
<p>The arch wiki has some instructions for setting up <a href="https://wiki.archlinux.org/title/Dnsmasq">dnsmasq</a>, a lightweight, easy to configure dhcp server.</p>
<p>For testing, I decided to use the subnet <code>fd00::/8</code> for the private ipv6 subnet I will be testing on.</p>
</section>
<section id="network-interfaces" class="level2">
<h2 class="anchored" data-anchor-id="network-interfaces">Network interfaces</h2>
<p>So I realized something. According to the <a href="https://docs.openstack.org/kolla-ansible/latest/admin/production-architecture-guide.html">kolla-ansible architechture guide</a>, ansible cannot recognize interface names with dashes. So because of this, I’ve decided to rename the wireguard interface from wg-stack to wgstack.</p>
<p>Another thing that looks a bit confusing is the <code>dns_interface</code> option, which appears to be used by designate for external dns requests. By default, this interface defaults to the same as the “network_interface”, which will not have public internet access on my vps (since I am using the wireguard as that interface). However, since I won’t be installing designate, it shouldn’t be too much of an issue?</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/moonpiedumplings\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>